<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ร้านเสื้อออนไลน์</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* CSS ของคุณ */
        body { font-family: 'Kanit', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; color: white; margin-bottom: 30px; padding: 20px; background: rgba(255, 255, 255, 0.1); border-radius: 15px; backdrop-filter: blur(10px); position: relative; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .nav-buttons { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; }
        .nav-buttons button { padding: 10px 20px; border: none; border-radius: 8px; background-color: #f8f9fa; color: #6a0dad; font-weight: bold; cursor: pointer; transition: background-color 0.3s ease; }
        .nav-buttons button:hover { background-color: #e2e6ea; }

        /* Cart Icon */
        .cart-icon { position: absolute; top: 20px; right: 20px; background-color: #f8f9fa; border-radius: 50%; width: 50px; height: 50px; display: flex; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: transform 0.2s ease; }
        .cart-icon:hover { transform: scale(1.05); }
        .cart-icon svg { width: 24px; height: 24px; fill: #6a0dad; }
        .cart-count { position: absolute; top: -5px; right: -5px; background-color: #e74c3c; color: white; border-radius: 50%; padding: 4px 8px; font-size: 0.8em; font-weight: bold; }

        .product-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .product-card { background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); overflow: hidden; text-align: center; padding-bottom: 15px; transition: transform 0.2s ease; }
        .product-card:hover { transform: translateY(-5px); }
        .product-card img { width: 100%; height: 250px; object-fit: cover; border-bottom: 1px solid #eee; }
        .product-card h3 { font-size: 1.4em; margin: 15px 10px 5px; color: #333; }
        .product-card p { font-size: 1.1em; color: #6a0dad; font-weight: bold; margin-bottom: 10px; }
        .product-card .detail-button { background-color: #6a0dad; color: white; padding: 10px 25px; border: none; border-radius: 6px; cursor: pointer; font-size: 1em; transition: background-color 0.3s ease; }
        .product-card .detail-button:hover { background-color: #5a099a; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 30px; border-radius: 15px; max-width: 600px; width: 90%; box-shadow: 0 5px 20px rgba(0,0,0,0.2); position: relative; }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; position: absolute; top: 10px; right: 20px; cursor: pointer; }
        .close-button:hover, .close-button:focus { color: black; text-decoration: none; cursor: pointer; }

        .modal-product-detail { display: flex; align-items: flex-start; gap: 20px; margin-bottom: 20px; }
        .modal-product-detail img { width: 200px; height: 200px; object-fit: cover; border-radius: 8px; }
        .modal-product-info { flex-grow: 1; text-align: left; }
        .modal-product-info h2 { font-size: 2em; margin-bottom: 10px; color: #6a0dad; }
        .modal-product-info p { margin-bottom: 5px; }
        .modal-product-info .price { font-size: 1.5em; font-weight: bold; color: #333; }
        .modal-product-info .stock { font-size: 0.9em; color: #777; }
        .modal-product-info .description { margin-top: 15px; font-style: italic; color: #555; }
        .modal-product-info .add-to-cart-section { margin-top: 20px; display: flex; align-items: center; gap: 10px; }
        .modal-product-info .add-to-cart-section input[type="number"] { width: 80px; padding: 8px; border-radius: 5px; border: 1px solid #ccc; text-align: center; }
        .modal-product-info .add-to-cart-button { background-color: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; transition: background-color 0.3s ease; }
        .modal-product-info .add-to-cart-button:hover { background-color: #0056b3; }

        /* Cart Modal Specifics */
        #cartModal .modal-content { max-width: 800px; }
        #cartItemsList { list-style: none; padding: 0; margin: 20px 0; max-height: 400px; overflow-y: auto; }
        #cartItemsList li { display: flex; align-items: center; justify-content: space-between; border-bottom: 1px dashed #eee; padding: 10px 0; }
        #cartItemsList li:last-child { border-bottom: none; }
        #cartItemsList img { width: 60px; height: 60px; object-fit: cover; border-radius: 5px; margin-right: 15px; }
        #cartItemsList .item-info { flex-grow: 1; }
        #cartItemsList .item-info h4 { margin: 0; font-size: 1.1em; color: #333; }
        #cartItemsList .item-info p { margin: 2px 0; font-size: 0.9em; color: #777; }
        #cartItemsList .item-actions { display: flex; align-items: center; gap: 10px; }
        #cartItemsList .item-actions span { font-weight: bold; color: #6a0dad; }
        #cartItemsList .item-actions button { background: none; border: none; font-size: 1.2em; cursor: pointer; color: #e74c3c; }
        #cartTotal { text-align: right; font-size: 1.5em; font-weight: bold; margin-top: 20px; color: #333; }
        #cartCheckoutForm { margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }
        .order-form-section .form-group { margin-bottom: 15px; text-align: left; }
        .order-form-section label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        .order-form-section input[type="text"],
        .order-form-section input[type="email"],
        .order-form-section input[type="tel"],
        .order-form-section input[type="number"],
        .order-form-section input[type="date"], /* Added for payment date */
        .order-form-section select, /* Added for bank selection */
        .order-form-section textarea,
        .order-form-section input[type="file"] { /* Added for file input */
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
            box-sizing: border-box; /* Important for file input width */
        }
        .submit-btn { background-color: #28a745; color: white; padding: 12px 30px; border: none; border-radius: 8px; cursor: pointer; font-size: 1.1em; width: 100%; margin-top: 20px; transition: background-color 0.3s ease; }
        .submit-btn:hover { background-color: #218838; }

        .loading { display: none; text-align: center; padding: 20px; }
        .spinner { border: 4px solid rgba(0,0,0,.1); border-left-color: #6a0dad; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .category-filter {
            margin-bottom: 20px;
            text-align: center;
        }
        .category-filter button {
            padding: 8px 15px;
            margin: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f0f0f0;
            cursor: pointer;
        }
        .category-filter button.active {
            background-color: #6a0dad;
            color: white;
            border-color: #6a0dad;
        }

        /* Payment Confirmation Section Styles */
        #paymentConfirmationSection {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            max-width: 700px;
            margin: 30px auto;
            text-align: center;
            display: none; /* Hidden by default */
        }
        #paymentConfirmationSection h2 {
            color: #28a745;
            margin-bottom: 20px;
            font-size: 2em;
        }
        #paymentConfirmationSection .bank-details {
            border: 1px dashed #ccc;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 10px;
            background-color: #f9f9f9;
            text-align: left;
        }
        #paymentConfirmationSection .bank-details p {
            margin-bottom: 10px;
            font-size: 1.1em;
            color: #555;
        }
        #paymentConfirmationSection .bank-details strong {
            color: #333;
        }
        #paymentConfirmationSection .bank-details span {
            font-weight: normal;
        }
        #paymentForm .form-group {
            margin-bottom: 15px;
            text-align: left;
        }
        #paymentForm label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        #paymentSlipPreview {
            max-width: 150px;
            max-height: 150px;
            margin-top: 10px;
            border: 1px solid #ddd;
            display: none;
            object-fit: contain;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>ร้านเสื้อออนไลน์</h1>
            <div class="nav-buttons">
                <button onclick="window.location.href='login.html'">เข้าสู่ระบบ Admin</button>
            </div>
            <div class="cart-icon" id="cartIcon">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path d="M0 24C0 10.7 10.7 0 24 0H69.5c22 0 41.5 12.8 50.6 32h411c26.3 0 45.5 25 38.6 50.4l-41 152.3c-8.5 31.4-37 53.3-69.5 53.3H170.7c-26.3 0-45.5-25-38.6-50.4L28.3 97.4c-6.5-24.2-29.3-41.4-54.6-41.4H24C10.7 56 0 45.3 0 32V24zm352 288c0 35.3 28.7 64 64 64s64-28.7 64-64s-28.7-64-64-64s-64 28.7-64 64zm-128 0c0 35.3 28.7 64 64 64s64-28.7 64-64s-28.7-64-64-64s-64 28.7-64 64z"/></svg>
                <span class="cart-count" id="cartCount">0</span>
            </div>
        </header>

        <div class="category-filter">
            <button class="active" data-category="all">ทั้งหมด</button>
            </div>

        <section class="product-grid" id="productGrid">
            </section>

        <div id="productDetailModal" class="modal">
            <div class="modal-content">
                <span class="close-button" id="closeProductDetailModal">&times;</span>
                <div class="modal-product-detail">
                    <img id="modalProductImage" src="" alt="Product Image">
                    <div class="modal-product-info">
                        <h2 id="modalProductName"></h2>
                        <p class="price">ราคา: <span id="modalProductPrice"></span> บาท</p>
                        <p class="category">หมวดหมู่: <span id="modalProductCategory"></span></p>
                        <p class="stock">คงเหลือ: <span id="modalProductStock"></span> ตัว</p>
                        <p class="description" id="modalProductDescription"></p>

                        <div class="add-to-cart-section">
                            <label for="modalQuantity">จำนวน:</label>
                            <input type="number" id="modalQuantity" min="1" value="1">
                            <button class="add-to-cart-button" id="addToCartButton">เพิ่มลงตะกร้า</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="cartModal" class="modal">
            <div class="modal-content">
                <span class="close-button" id="closeCartModal">&times;</span>
                <h2>ตะกร้าสินค้าของคุณ</h2>
                <ul id="cartItemsList">
                    </ul>
                <div id="cartTotal">ราคารวม: <span>0</span> บาท</div>

                <div class="order-form-section" id="cartCheckoutForm">
                    <h3>กรอกข้อมูลเพื่อยืนยันคำสั่งซื้อ</h3>
                    <form id="checkoutForm">
                        <div class="form-group">
                            <label for="customerName">ชื่อ-นามสกุล:</label>
                            <input type="text" id="checkoutCustomerName" required>
                        </div>
                        <div class="form-group">
                            <label for="phone">เบอร์โทรศัพท์:</label>
                            <input type="tel" id="checkoutPhone" required>
                        </div>
                        <div class="form-group">
                            <label for="email">อีเมล:</label>
                            <input type="email" id="checkoutEmail" required>
                        </div>
                        <div class="form-group">
                            <label for="address">ที่อยู่จัดส่ง:</label>
                            <textarea id="checkoutAddress" rows="3" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="note">หมายเหตุ:</label>
                            <textarea id="checkoutNote" rows="2" placeholder="ข้อมูลเพิ่มเติม (ไม่จำเป็น)"></textarea>
                        </div>
                        
                        <button type="submit" class="submit-btn">ยืนยันคำสั่งซื้อ</button>
                    </form>

                    <div class="loading" id="checkoutLoading">
                        <div class="spinner"></div>
                        <p>กำลังส่งคำสั่งซื้อ...</p>
                    </div>
                    <p id="checkoutMessage" style="text-align: center; margin-top: 15px;"></p>
                </div>
            </div>
        </div>

        <div id="paymentConfirmationSection" style="display: none;">
            <h2>ขั้นตอนต่อไป: ชำระเงิน</h2>
            <p>กรุณาโอนเงินตามรายละเอียดด้านล่าง และแนบสลิปเพื่อยืนยันการชำระเงิน</p>
            <p style="font-weight: bold;">หมายเลขคำสั่งซื้อของคุณ: <span id="paymentOrderIdDisplay" style="color: #6a0dad;"></span></p>

            <div class="bank-details">
                <p><strong>ธนาคาร:</strong> <span id="bankNameDisplay">ธนาคารกสิกรไทย</span></p>
                <p><strong>ชื่อบัญชี:</strong> <span id="accountNameDisplay">ร้านเสื้อออนไลน์ จำกัด</span></p>
                <p><strong>เลขที่บัญชี:</strong> <span id="accountNumberDisplay">XXX-X-XXXXX-X</span></p>
                <p><strong>จำนวนเงินที่ต้องชำระ:</strong> <span id="amountToPayDisplay" style="color: #e74c3c; font-size: 1.2em;">0</span> บาท</p>
            </div>

            <h3>ยืนยันการชำระเงิน</h3>
            <form id="paymentForm">
                <input type="hidden" id="paymentConfirmOrderId">
                <input type="hidden" id="paymentConfirmAmount">

                <div class="form-group">
                    <label for="payerName">ชื่อผู้โอน (ตามสลิป):</label>
                    <input type="text" id="payerName" required>
                </div>
                <div class="form-group">
                    <label for="payerBank">โอนจากธนาคาร:</label>
                    <select id="payerBank" required>
                        <option value="">เลือกธนาคาร</option>
                        <option value="กสิกรไทย">กสิกรไทย</option>
                        <option value="ไทยพาณิชย์">ไทยพาณิชย์</option>
                        <option value="กรุงไทย">กรุงไทย</option>
                        <option value="กรุงเทพ">กรุงเทพ</option>
                        <option value="ทหารไทยธนชาต">ทหารไทยธนชาต</option>
                        <option value="ออมสิน">ออมสิน</option>
                        <option value="อื่นๆ">อื่นๆ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="amountPaid">จำนวนเงินที่โอน:</label>
                    <input type="number" id="amountPaid" step="0.01" required>
                </div>
                 <div class="form-group">
                    <label for="paymentDate">วันที่และเวลาที่โอน:</label>
                    <input type="date" id="paymentDate" required>
                </div>
                <div class="form-group">
                    <label for="paymentSlip">แนบสลิปโอนเงิน (รูปภาพ):</label>
                    <input type="file" id="paymentSlip" accept="image/*" required>
                    <img id="paymentSlipPreview" src="#" alt="Payment Slip Preview">
                </div>
                
                <button type="submit" class="submit-btn">ยืนยันการชำระเงิน</button>
            </form>

            <div class="loading" id="paymentLoading" style="display: none;">
                <div class="spinner"></div>
                <p>กำลังส่งข้อมูลการชำระเงิน...</p>
            </div>
            <p id="paymentMessage" style="text-align: center; margin-top: 15px;"></p>
        </div>

    </div>

<script>
    const API_URL = 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE'; // ตรวจสอบให้แน่ใจว่า URL นี้ถูกต้อง!
    // ... (โค้ดส่วนอื่นๆ)

    // --- Checkout Form Submission ---
    checkoutForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        
        if (cart.length === 0) {
            alert('ตะกร้าสินค้าของคุณว่างเปล่า ไม่สามารถดำเนินการสั่งซื้อได้');
            return;
        }

        checkoutLoading.style.display = 'block'; 
        checkoutMessage.textContent = ''; 
        document.querySelector('#checkoutForm button[type="submit"]').disabled = true; // Disable button

        const customerName = document.getElementById('checkoutCustomerName').value;
        const phone = document.getElementById('checkoutPhone').value;
        const email = document.getElementById('checkoutEmail').value;
        const address = document.getElementById('checkoutAddress').value;
        const note = document.getElementById('checkoutNote').value;
        const total = parseFloat(cartTotalSpan.textContent);

        // *** เปลี่ยนแปลงตรงนี้: สร้าง FormData แทนการใช้ JSON.stringify ***
        const formData = new FormData();
        formData.append('customerName', customerName);
        formData.append('phone', phone);
        formData.append('email', email);
        formData.append('address', address);
        formData.append('note', note);
        formData.append('total', total);
        formData.append('cartItems', JSON.stringify(cart)); // cartItems ต้องถูกแปลงเป็น JSON string ก่อน

        try {
            const response = await fetch(`${API_URL}?action=createOrder`, {
                method: 'POST',
                // REMOVE THIS LINE: headers: { 'Content-Type': 'application/json' }, // ลบบรรทัดนี้ออก
                body: formData // ใช้ formData ที่สร้างขึ้น
            });
            const data = await response.json();

            // ... (โค้ดส่วนที่เหลือของ checkoutForm)
        } catch (error) {
            console.error('Network error during order creation:', error);
            checkoutMessage.textContent = 'เกิดข้อผิดพลาดในการเชื่อมต่อ: ' + error.message;
            checkoutMessage.style.color = 'red';
        } finally {
            checkoutLoading.style.display = 'none'; 
            document.querySelector('#checkoutForm button[type="submit"]').disabled = false;
        }
    });

    // --- Payment Confirmation Form Submission ---
    paymentForm.addEventListener('submit', async (event) => {
        event.preventDefault();

        paymentLoading.style.display = 'block';
        paymentMessage.textContent = '';
        document.querySelector('#paymentForm button[type="submit"]').disabled = true;

        const orderId = document.getElementById('paymentConfirmOrderId').value;
        const payerName = document.getElementById('payerName').value;
        const payerBank = document.getElementById('payerBank').value;
        const amountPaid = parseFloat(document.getElementById('amountPaid').value);
        const paymentDate = document.getElementById('paymentDate').value;
        const paymentSlipFile = document.getElementById('paymentSlip').files[0];

        if (!paymentSlipFile) {
            alert('โปรดแนบรูปสลิปโอนเงิน');
            paymentLoading.style.display = 'none';
            document.querySelector('#paymentForm button[type="submit"]').disabled = false;
            return;
        }

        const reader = new FileReader();
        reader.readAsDataURL(paymentSlipFile);

        reader.onloadend = async () => {
            const slipBase64 = reader.result; // data:image/png;base64,...
            const slipMimeType = paymentSlipFile.type;

            // *** เปลี่ยนแปลงตรงนี้: สร้าง FormData แทนการใช้ JSON.stringify ***
            const formData = new FormData();
            formData.append('orderId', orderId);
            formData.append('payerName', payerName);
            formData.append('payerBank', payerBank);
            formData.append('amountPaid', amountPaid);
            formData.append('paymentDate', paymentDate);
            formData.append('slipBase64', slipBase64);
            formData.append('slipMimeType', slipMimeType);

            try {
                const response = await fetch(`${API_URL}?action=confirmPayment`, {
                    method: 'POST',
                    // REMOVE THIS LINE: headers: { 'Content-Type': 'application/json' }, // ลบบรรทัดนี้ออก
                    body: formData // ใช้ formData ที่สร้างขึ้น
                });
                const data = await response.json();

                // ... (โค้ดส่วนที่เหลือของ paymentForm)
            } catch (error) {
                console.error('Network error during payment confirmation:', error);
                paymentMessage.textContent = 'เกิดข้อผิดพลาดในการเชื่อมต่อ: ' + error.message;
                paymentMessage.style.color = 'red';
            } finally {
                paymentLoading.style.display = 'none';
                document.querySelector('#paymentForm button[type="submit"]').disabled = false;
            }
        };

        // Preview payment slip image
        paymentSlipInput.addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    paymentSlipPreview.src = e.target.result;
                    paymentSlipPreview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                paymentSlipPreview.src = '#';
                paymentSlipPreview.style.display = 'none';
            }
        });
    </script>
</body>
</html>
