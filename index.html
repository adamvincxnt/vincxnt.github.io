<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ร้านเสื้อออนไลน์</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* CSS ของคุณ */
        body { font-family: 'Kanit', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; color: white; margin-bottom: 30px; padding: 20px; background: rgba(255, 255, 255, 0.1); border-radius: 15px; backdrop-filter: blur(10px); }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .nav-buttons { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; }
        .nav-buttons button { padding: 10px 20px; border: none; border-radius: 8px; background-color: #f8f9fa; color: #6a0dad; font-weight: bold; cursor: pointer; transition: background-color 0.3s ease; }
        .nav-buttons button:hover { background-color: #e2e6ea; }

        .product-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .product-card { background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); overflow: hidden; text-align: center; padding-bottom: 15px; transition: transform 0.2s ease; }
        .product-card:hover { transform: translateY(-5px); }
        .product-card img { width: 100%; height: 250px; object-fit: cover; border-bottom: 1px solid #eee; }
        .product-card h3 { font-size: 1.4em; margin: 15px 10px 5px; color: #333; }
        .product-card p { font-size: 1.1em; color: #6a0dad; font-weight: bold; margin-bottom: 10px; }
        .product-card button { background-color: #6a0dad; color: white; padding: 10px 25px; border: none; border-radius: 6px; cursor: pointer; font-size: 1em; transition: background-color 0.3s ease; }
        .product-card button:hover { background-color: #5a099a; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 30px; border-radius: 15px; max-width: 600px; width: 90%; box-shadow: 0 5px 20px rgba(0,0,0,0.2); position: relative; }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; position: absolute; top: 10px; right: 20px; cursor: pointer; }
        .close-button:hover, .close-button:focus { color: black; text-decoration: none; cursor: pointer; }

        .modal-product-detail { display: flex; align-items: flex-start; gap: 20px; margin-bottom: 20px; }
        .modal-product-detail img { width: 200px; height: 200px; object-fit: cover; border-radius: 8px; }
        .modal-product-info { flex-grow: 1; text-align: left; }
        .modal-product-info h2 { font-size: 2em; margin-bottom: 10px; color: #6a0dad; }
        .modal-product-info p { margin-bottom: 5px; }
        .modal-product-info .price { font-size: 1.5em; font-weight: bold; color: #333; }
        .modal-product-info .stock { font-size: 0.9em; color: #777; }
        .modal-product-info .description { margin-top: 15px; font-style: italic; color: #555; }

        .order-form-section .form-group { margin-bottom: 15px; text-align: left; }
        .order-form-section label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        .order-form-section input[type="text"],
        .order-form-section input[type="email"],
        .order-form-section input[type="tel"],
        .order-form-section input[type="number"],
        .order-form-section textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
        }
        .submit-btn { background-color: #28a745; color: white; padding: 12px 30px; border: none; border-radius: 8px; cursor: pointer; font-size: 1.1em; width: 100%; margin-top: 20px; transition: background-color 0.3s ease; }
        .submit-btn:hover { background-color: #218838; }

        .loading { display: none; text-align: center; padding: 20px; }
        .spinner { border: 4px solid rgba(0,0,0,.1); border-left-color: #6a0dad; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .category-filter {
            margin-bottom: 20px;
            text-align: center;
        }
        .category-filter button {
            padding: 8px 15px;
            margin: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f0f0f0;
            cursor: pointer;
        }
        .category-filter button.active {
            background-color: #6a0dad;
            color: white;
            border-color: #6a0dad;
        }

    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>ร้านเสื้อออนไลน์</h1>
            <div class="nav-buttons">
                <button onclick="window.location.href='login.html'">เข้าสู่ระบบ Admin</button>
            </div>
        </header>

        <div class="category-filter">
            <button class="active" data-category="all">ทั้งหมด</button>
            <!-- หมวดหมู่อื่นๆ จะถูกเพิ่มด้วย JavaScript -->
        </div>

        <section class="product-grid" id="productGrid">
            <!-- สินค้าจะถูกโหลดและแสดงผลที่นี่ -->
        </section>

        <!-- Modal สำหรับรายละเอียดสินค้าและฟอร์มสั่งซื้อ -->
        <div id="productModal" class="modal">
            <div class="modal-content">
                <span class="close-button">&times;</span>
                <div class="modal-product-detail">
                    <img id="modalProductImage" src="" alt="Product Image">
                    <div class="modal-product-info">
                        <h2 id="modalProductName"></h2>
                        <p class="price">ราคา: <span id="modalProductPrice"></span> บาท</p>
                        <p class="category">หมวดหมู่: <span id="modalProductCategory"></span></p>
                        <p class="stock">คงเหลือ: <span id="modalProductStock"></span> ตัว</p>
                        <p class="description" id="modalProductDescription"></p>
                    </div>
                </div>

                <div class="order-form-section">
                    <h3>กรอกข้อมูลเพื่อสั่งซื้อ</h3>
                    <form id="orderForm">
                        <input type="hidden" id="orderProductId">
                        <input type="hidden" id="orderProductName">
                        <input type="hidden" id="orderProductPrice">

                        <div class="form-group">
                            <label for="customerName">ชื่อ-นามสกุล:</label>
                            <input type="text" id="customerName" required>
                        </div>
                        <div class="form-group">
                            <label for="phone">เบอร์โทรศัพท์:</label>
                            <input type="tel" id="phone" required>
                        </div>
                        <div class="form-group">
                            <label for="email">อีเมล:</label>
                            <input type="email" id="email" required>
                        </div>
                        <div class="form-group">
                            <label for="address">ที่อยู่จัดส่ง:</label>
                            <textarea id="address" rows="3" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="quantity">จำนวน:</label>
                            <input type="number" id="quantity" min="1" value="1" required>
                        </div>
                        <div class="form-group">
                            <label>ราคารวม:</label>
                            <span id="totalPrice">0</span> บาท
                        </div>
                        
                        <button type="submit" class="submit-btn">สั่งซื้อเลย</button>
                    </form>

                    <div class="loading" id="loading">
                        <div class="spinner"></div>
                        <p>กำลังส่งคำสั่งซื้อ...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbzkb_mtZTOW57gTPkjJaVOSvql1jyuWOtoqTuvpYXJG8yp5Kvd2nF4VHL4mnsM9WTCtjg/exec'; // **สำคัญ: เปลี่ยนเป็น URL ที่ Deploy แล้ว**
        
        let allProducts = []; // เก็บสินค้าทั้งหมด
        let currentCategories = []; // เก็บหมวดหมู่ทั้งหมด

        // โหลดสินค้าและหมวดหมู่เมื่อหน้าเว็บเริ่มต้น
        window.onload = function() {
            loadAllData();
        };

        async function loadAllData() {
            await loadCategories();
            await loadProducts();
        }

        // ฟังก์ชันโหลดหมวดหมู่
        async function loadCategories() {
            try {
                const response = await fetch(`${API_URL}?action=getCategories`);
                const data = await response.json();
                if (data.success) {
                    currentCategories = data.categories;
                    displayCategoryFilters();
                } else {
                    console.error('Error loading categories:', data.error);
                }
            } catch (error) {
                console.error('Network error loading categories:', error);
            }
        }

        // ฟังก์ชันแสดงปุ่มกรองหมวดหมู่
        function displayCategoryFilters() {
            const categoryFilterDiv = document.querySelector('.category-filter');
            categoryFilterDiv.innerHTML = '<button class="active" data-category="all">ทั้งหมด</button>'; // Reset filter

            currentCategories.forEach(cat => {
                const button = document.createElement('button');
                button.textContent = cat.categoryname;
                button.dataset.category = cat.categoryname;
                categoryFilterDiv.appendChild(button);
            });

            categoryFilterDiv.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    // Remove active from all buttons
                    Array.from(categoryFilterDiv.children).forEach(btn => btn.classList.remove('active'));
                    // Add active to clicked button
                    e.target.classList.add('active');
                    filterProducts(e.target.dataset.category);
                }
            });
        }

        // ฟังก์ชันกรองสินค้า
        function filterProducts(category) {
            const filteredProducts = category === 'all' 
                ? allProducts 
                : allProducts.filter(p => p.category === category);
            displayProducts(filteredProducts);
        }


        // ฟังก์ชันโหลดสินค้า
        async function loadProducts() {
            try {
                const response = await fetch(`${API_URL}?action=getProducts`);
                const data = await response.json();
                
                if (data.success) {
                    allProducts = data.products; // เก็บสินค้าทั้งหมด
                    displayProducts(allProducts); // แสดงสินค้าทั้งหมดในตอนแรก
                } else {
                    console.error('Error loading products:', data.error);
                    alert('ไม่สามารถโหลดสินค้าได้: ' + data.error);
                }
            } catch (error) {
                console.error('Network error loading products:', error);
                alert('เกิดข้อผิดพลาดในการเชื่อมต่อ: ' + error.message);
            }
        }

        // ฟังก์ชันแสดงสินค้าใน Grid
        function displayProducts(productsToDisplay) {
            const productGrid = document.getElementById('productGrid');
            productGrid.innerHTML = ''; // เคลียร์ของเก่า

            if (productsToDisplay.length === 0) {
                productGrid.innerHTML = '<p style="text-align: center; color: white; grid-column: 1 / -1;">ไม่พบสินค้าในหมวดหมู่นี้</p>';
                return;
            }

            productsToDisplay.forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card';
                card.innerHTML = `
                    <img src="${product.image}" alt="${product.name}">
                    <h3>${product.name}</h3>
                    <p>${product.price} บาท</p>
                    <button data-id="${product.id}">ดูรายละเอียด</button>
                `;
                card.querySelector('button').addEventListener('click', () => openProductModal(product));
                productGrid.appendChild(card);
            });
        }

        // ฟังก์ชันเปิด Modal แสดงรายละเอียดสินค้า
        const productModal = document.getElementById('productModal');
        const closeButton = document.querySelector('.close-button');
        const quantityInput = document.getElementById('quantity');
        const totalPriceSpan = document.getElementById('totalPrice');
        const orderForm = document.getElementById('orderForm');
        const loadingSpinner = document.getElementById('loading');

        function openProductModal(product) {
            document.getElementById('modalProductImage').src = product.image;
            document.getElementById('modalProductName').textContent = product.name;
            document.getElementById('modalProductPrice').textContent = product.price;
            document.getElementById('modalProductCategory').textContent = product.category; // แสดงหมวดหมู่
            document.getElementById('modalProductStock').textContent = product.stock;
            document.getElementById('modalProductDescription').textContent = product.description;

            document.getElementById('orderProductId').value = product.id;
            document.getElementById('orderProductName').value = product.name;
            document.getElementById('orderProductPrice').value = product.price;

            quantityInput.value = 1; // รีเซ็ตจำนวน
            updateTotalPrice(); // อัปเดตราคารวมเริ่มต้น

            productModal.style.display = 'flex';
        }

        closeButton.addEventListener('click', () => {
            productModal.style.display = 'none';
            orderForm.reset(); // รีเซ็ตฟอร์มเมื่อปิด modal
        });

        window.addEventListener('click', (event) => {
            if (event.target === productModal) {
                productModal.style.display = 'none';
                orderForm.reset();
            }
        });

        // อัปเดตราคารวมเมื่อจำนวนเปลี่ยน
        quantityInput.addEventListener('input', updateTotalPrice);

        function updateTotalPrice() {
            const price = parseFloat(document.getElementById('orderProductPrice').value);
            const quantity = parseInt(quantityInput.value);
            const total = isNaN(price) || isNaN(quantity) ? 0 : price * quantity;
            totalPriceSpan.textContent = total.toFixed(0);
        }

        // ฟังก์ชันส่งคำสั่งซื้อ
        orderForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            
            loadingSpinner.style.display = 'block'; // แสดง spinner

            const formData = new FormData(orderForm);
            const params = new URLSearchParams();
            for (const [key, value] of formData.entries()) {
                params.append(key, value);
            }
            params.append('action', 'createOrder');
            params.append('product', document.getElementById('orderProductName').value); // ชื่อสินค้า
            params.append('total', totalPriceSpan.textContent); // ราคารวม

            try {
                const response = await fetch(`${API_URL}?${params.toString()}`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (data.success) {
                    alert(`สั่งซื้อสำเร็จ! หมายเลขคำสั่งซื้อ: ${data.orderId}`);
                    productModal.style.display = 'none';
                    orderForm.reset();
                } else {
                    alert('เกิดข้อผิดพลาดในการสั่งซื้อ: ' + data.error);
                }
            } catch (error) {
                console.error('Network error during order creation:', error);
                alert('เกิดข้อผิดพลาดในการเชื่อมต่อ: ' + error.message);
            } finally {
                loadingSpinner.style.display = 'none'; // ซ่อน spinner
            }
        });
    </script>
</body>
</html>
