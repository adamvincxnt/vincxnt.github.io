<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ร้านเสื้อออนไลน์</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        /* CSS เดิม */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Kanit', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            position: relative; /* สำหรับตำแหน่งตะกร้า */
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .nav-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .nav-btn.active {
            background: rgba(255, 255, 255, 0.4);
            transform: scale(1.05);
        }

        .products-grid, .categories-grid { /* ปรับใช้ทั้งคู่ */
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* ลดขนาดเล็กน้อยสำหรับตาราง 3x3 หรือ 4x4 */
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .product-card, .category-card { /* ปรับใช้ทั้งคู่ */
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
        }

        .product-card:hover, .category-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 25px 50px rgba(0,0,0,0.2);
        }

        /* สำหรับรูปภาพที่เป็นสี่เหลี่ยมจัตุรัส */
        .product-image, .category-image {
            width: 100%;
            height: 250px; /* กำหนดความสูงเท่ากับความกว้างของ card */
            object-fit: cover; /* ครอบคลุมพื้นที่และตัดส่วนเกิน */
            transition: transform 0.3s ease;
            display: block; /* แก้ปัญหาช่องว่างด้านล่างรูปภาพ */
        }

        .product-card:hover .product-image, .category-card:hover .category-image {
            transform: scale(1.05);
        }

        .product-info, .category-info {
            padding: 20px;
            flex-grow: 1; /* ทำให้เนื้อหาขยายเต็มพื้นที่ */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .product-name, .category-name {
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            text-align: center; /* จัดกลางสำหรับชื่อหมวดหมู่ */
        }

        .product-price {
            font-size: 1.5em;
            color: #e74c3c;
            font-weight: 700;
            margin-bottom: 15px;
        }

        .product-details {
            color: #666;
            margin-bottom: 15px;
            font-size: 0.9em;
        }

        .buy-btn, .add-to-cart-btn { /* แยกปุ่มสั่งซื้อและเพิ่มลงตะกร้า */
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            transition: all 0.3s ease;
            margin-top: auto; /* จัดตำแหน่งปุ่มไว้ด้านล่างเสมอ */
        }

        .buy-btn:hover, .add-to-cart-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            backdrop-filter: blur(5px);
            overflow-y: auto;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 30px;
            color: #999;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close-btn:hover {
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quantity-btn {
            background: #667eea;
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: background 0.3s ease;
        }

        .quantity-btn:hover {
            background: #764ba2;
        }

        .quantity-input {
            width: 80px;
            text-align: center;
        }

        .order-summary, .cart-summary { /* ใช้ร่วมกัน */
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .total-price {
            font-size: 1.5em;
            font-weight: 700;
            color: #e74c3c;
            text-align: center;
            margin: 15px 0;
        }

        .submit-btn, .checkout-btn { /* ปุ่มสั่งซื้อและ Checkout */
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            width: 100%;
            transition: all 0.3s ease;
        }

        .submit-btn:hover, .checkout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(40, 167, 69, 0.3);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #c3e6cb;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #f5c6cb;
        }

        /* Admin Panel Styles */
        #admin-panel {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }

        #admin-panel h2 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }

        .admin-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f0f0f0;
            border-radius: 15px;
        }

        .admin-section h3 {
            color: #555;
            margin-bottom: 15px;
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .admin-table th, .admin-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
            vertical-align: top;
        }

        .admin-table th {
            background-color: #eee;
            font-weight: 600;
            color: #333;
        }

        .admin-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .admin-table button {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 5px;
            font-size: 0.9em;
            transition: background 0.2s ease;
        }

        .admin-table .edit-btn {
            background-color: #007bff;
            color: white;
        }
        .admin-table .edit-btn:hover { background-color: #0056b3; }

        .admin-table .delete-btn {
            background-color: #dc3545;
            color: white;
        }
        .admin-table .delete-btn:hover { background-color: #c82333; }

        .admin-table .update-status-btn {
            background-color: #ffc107;
            color: #333;
        }
        .admin-table .update-status-btn:hover { background-color: #e0a800; }

        .add-product-form, .edit-product-form {
            background: #fff;
            padding: 25px;
            border-radius: 10px;
            margin-top: 20px;
            border: 1px solid #eee;
        }
        .add-product-form h3, .edit-product-form h3 {
            margin-bottom: 20px;
            color: #333;
        }

        .admin-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Cart Icon */
        .cart-icon {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: transform 0.2s ease;
        }

        .cart-icon:hover {
            transform: scale(1.1);
        }

        .cart-icon img {
            width: 28px;
            height: 28px;
        }

        .cart-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            padding: 5px 8px;
            font-size: 0.8em;
            font-weight: bold;
            line-height: 1;
        }

        /* Cart Modal */
        #cartModal .cart-items-list {
            list-style: none;
            padding: 0;
            margin-bottom: 20px;
            border-top: 1px solid #eee;
        }

        #cartModal .cart-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid #eee;
        }

        #cartModal .cart-item-info {
            flex-grow: 1;
        }

        #cartModal .cart-item-name {
            font-weight: bold;
            color: #333;
        }

        #cartModal .cart-item-price {
            font-size: 0.9em;
            color: #666;
        }

        #cartModal .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #cartModal .cart-item-quantity-input {
            width: 50px;
            text-align: center;
            padding: 5px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        #cartModal .remove-item-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 0.8em;
        }

        #cartModal .empty-cart-message {
            text-align: center;
            color: #666;
            margin: 20px 0;
        }

        /* Category Filter */
        .category-filter {
            text-align: center;
            margin-bottom: 30px;
        }

        .category-filter-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 15px;
            transition: all 0.3s ease;
            margin: 5px;
            backdrop-filter: blur(5px);
        }

        .category-filter-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .category-filter-btn.active {
            background: rgba(255, 255, 255, 0.4);
            transform: scale(1.05);
        }


        /* Media Queries */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }

            .nav-buttons {
                flex-direction: column;
                align-items: center;
            }

            .products-grid, .categories-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
                padding: 20px;
            }

            .admin-table th, .admin-table td {
                padding: 8px;
                font-size: 0.9em;
            }
            .admin-table button {
                padding: 6px 10px;
            }
            .cart-icon {
                width: 45px;
                height: 45px;
                top: 15px;
                right: 15px;
            }
            .cart-icon img {
                width: 24px;
                height: 24px;
            }
            .cart-count {
                padding: 3px 6px;
                font-size: 0.7em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🛍️ ร้านเสื้อออนไลน์</h1>
            <p>คุณภาพดี ราคาย่อมเยา จัดส่งฟรีทั่วไทย</p>
            <div class="cart-icon" onclick="openCartModal()">
                <img src="https://img.icons8.com/ios-filled/50/shopping-cart.png" alt="Cart">
                <span class="cart-count" id="cartCount">0</span>
            </div>
        </div>

        <div class="nav-buttons">
            <button class="nav-btn active" id="categoriesNavBtn" onclick="showSection('categories-section')">🏠 หน้าแรก</button>
            <button class="nav-btn" id="orderStatusNavBtn" onclick="showSection('order-status-section')">📋 เช็คสถานะ</button>
            <button class="nav-btn" id="contactNavBtn" onclick="showSection('contact-section')">📞 ติดต่อ</button>
            <button class="nav-btn" id="adminNavBtn" onclick="showSection('admin-section')">⚙️ จัดการ</button>
        </div>

        <div id="categories-section" class="content-section">
            <h2 style="color: white; text-align: center; margin-bottom: 20px;">เลือกหมวดหมู่สินค้า</h2>
            <div class="categories-grid" id="categories-grid">
                </div>
            <div id="noCategoriesMessage" style="text-align: center; color: white; display: none;">
                ไม่พบหมวดหมู่ในขณะนี้
            </div>
        </div>

        <div id="products-section" class="content-section" style="display: none;">
            <div class="category-filter" id="categoryFilter">
                <button class="category-filter-btn active" onclick="loadProducts('All')">สินค้าทั้งหมด</button>
                </div>
            <div class="products-grid" id="products-grid">
                </div>
            <div id="noProductsMessage" style="text-align: center; color: white; display: none;">
                ไม่พบสินค้าในหมวดหมู่นี้
            </div>
        </div>

        <div id="order-status-section" class="content-section" style="display: none;">
            <div style="background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 20px; text-align: center;">
                <h2 style="color: #333; margin-bottom: 20px;">🔍 ตรวจสอบสถานะคำสั่งซื้อ</h2>
                <div class="form-group">
                    <input type="text" id="orderIdInput" placeholder="กรอกหมายเลขคำสั่งซื้อ" style="max-width: 300px; margin: 0 auto;">
                </div>
                <button onclick="checkOrderStatus()" class="submit-btn" style="max-width: 200px;">ตรวจสอบ</button>
                <div id="orderStatusResult" style="margin-top: 20px;"></div>
                <div class="loading" id="orderStatusLoading">
                    <div class="spinner"></div>
                    <p>กำลังตรวจสอบสถานะ...</p>
                </div>
            </div>
        </div>

        <div id="contact-section" class="content-section" style="display: none;">
            <div style="background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 20px; text-align: center;">
                <h2 style="color: #333; margin-bottom: 20px;">📞 ติดต่อเรา</h2>
                <div style="max-width: 400px; margin: 0 auto; text-align: left;">
                    <p style="margin-bottom: 15px;"><strong>📱 เบอร์โทร:</strong> 02-123-4567</p>
                    <p style="margin-bottom: 15px;"><strong>📧 อีเมล:</strong> info@shirtshop.com</p>
                    <p style="margin-bottom: 15px;"><strong>💬 Line ID:</strong> @shirtshop</p>
                    <p style="margin-bottom: 15px;"><strong>🕒 เวลาทำการ:</strong> จันทร์-ศุกร์ 9:00-18:00</p>
                    <p style="margin-bottom: 15px;"><strong>📦 จัดส่ง:</strong> ใช้บริการ Kerry Express</p>
                </div>
            </div>
        </div>

        <div id="admin-section" class="content-section" style="display: none;">
            <div id="admin-login-area">
                <div style="background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 20px; text-align: center; max-width: 400px; margin: 0 auto;">
                    <h2 style="color: #333; margin-bottom: 20px;">🔑 เข้าสู่ระบบผู้ดูแล</h2>
                    <div class="form-group">
                        <label for="adminUsername">ชื่อผู้ใช้:</label>
                        <input type="text" id="adminUsername" placeholder="Useradmin" required>
                    </div>
                    <div class="form-group">
                        <label for="adminPassword">รหัสผ่าน:</label>
                        <input type="password" id="adminPassword" placeholder="Password" required>
                    </div>
                    <button onclick="adminLogin()" class="submit-btn">เข้าสู่ระบบ</button>
                    <div id="adminLoginMessage" style="margin-top: 15px;"></div>
                    <div class="loading" id="adminLoginLoading">
                        <div class="spinner"></div>
                        <p>กำลังเข้าสู่ระบบ...</p>
                    </div>
                </div>
            </div>

            <div id="admin-panel" style="display: none;">
                <h2>⚙️ แผงควบคุมผู้ดูแล</h2>
                <button onclick="adminLogout()" class="nav-btn" style="margin-bottom: 20px;">ออกจากระบบ</button>

                <div class="admin-section">
                    <h3>สินค้าทั้งหมด</h3>
                    <button onclick="showAddProductForm()" class="submit-btn" style="margin-bottom: 20px; max-width: 200px;">+ เพิ่มสินค้าใหม่</button>
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>ชื่อ</th>
                                <th>ราคา</th>
                                <th>สต็อก</th>
                                <th>หมวดหมู่</th>
                                <th>การจัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="adminProductTableBody">
                            </tbody>
                    </table>
                    <div id="noAdminProductsMessage" style="text-align: center; margin-top: 15px; display: none;">
                        ยังไม่มีสินค้า.
                    </div>
                </div>

                <div id="addProductForm" class="add-product-form" style="display: none;">
                    <h3>เพิ่มสินค้าใหม่</h3>
                    <form id="productEntryForm">
                        <input type="hidden" id="productId">
                        <div class="form-group">
                            <label for="productName">ชื่อสินค้า:</label>
                            <input type="text" id="productName" required>
                        </div>
                        <div class="form-group">
                            <label for="productPrice">ราคา:</label>
                            <input type="number" id="productPrice" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="productImage">URL รูปภาพ:</label>
                            <input type="url" id="productImage" placeholder="https://via.placeholder.com/300" required>
                        </div>
                        <div class="form-group">
                            <label for="productSize">ขนาด (คั่นด้วยคอมมา เช่น S,M,L):</label>
                            <input type="text" id="productSize" required>
                        </div>
                        <div class="form-group">
                            <label for="productColor">สี:</label>
                            <input type="text" id="productColor" required>
                        </div>
                        <div class="form-group">
                            <label for="productStock">สต็อก:</label>
                            <input type="number" id="productStock" required>
                        </div>
                        <div class="form-group">
                            <label for="productDescription">รายละเอียด:</label>
                            <textarea id="productDescription" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="productCategory">หมวดหมู่:</label>
                            <input type="text" id="productCategory" required placeholder="เช่น เสื้อยืด, กางเกง">
                        </div>
                        <button type="submit" class="submit-btn" id="submitProductBtn">เพิ่มสินค้า</button>
                        <button type="button" class="nav-btn" onclick="cancelProductEdit()">ยกเลิก</button>
                    </form>
                    <div class="loading" id="productFormLoading">
                        <div class="spinner"></div>
                        <p>กำลังดำเนินการ...</p>
                    </div>
                    <div id="productFormMessage" style="margin-top: 15px;"></div>
                </div>

                <div class="admin-section" style="margin-top: 30px;">
                    <h3>คำสั่งซื้อทั้งหมด</h3>
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>ลูกค้า</th>
                                <th>สินค้า</th>
                                <th>รวม</th>
                                <th>สถานะ</th>
                                <th>วันที่</th>
                                <th>การจัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="adminOrderTableBody">
                            </tbody>
                    </table>
                    <div id="noAdminOrdersMessage" style="text-align: center; margin-top: 15px; display: none;">
                        ยังไม่มีคำสั่งซื้อ.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="productDetailsModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeProductDetailsModal()">&times;</span>
            <h2 id="modalProductName" style="color: #333; margin-bottom: 20px;"></h2>
            <img id="modalProductImage" src="" alt="" class="product-image" style="margin-bottom: 15px; border-radius: 10px;">
            <p id="modalProductDescription" style="color: #666; margin-bottom: 10px;"></p>
            <p id="modalProductStock" style="font-weight: bold; margin-bottom: 15px;"></p>

            <div class="form-group">
                <label>ขนาด:</label>
                <select id="modalProductSize">
                    </select>
            </div>
            <div class="form-group">
                <label>จำนวน:</label>
                <div class="quantity-controls">
                    <button class="quantity-btn" onclick="changeModalQuantity(-1)">-</button>
                    <input type="number" id="modalQuantity" class="quantity-input" value="1" min="1">
                    <button class="quantity-btn" onclick="changeModalQuantity(1)">+</button>
                </div>
            </div>
            <div class="total-price" id="modalProductPriceTotal">฿0</div>
            <button class="add-to-cart-btn" onclick="addToCart()">เพิ่มลงตะกร้า</button>
            <div id="productDetailsMessage" style="margin-top: 15px;"></div>
        </div>
    </div>

    <div id="cartModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeCartModal()">&times;</span>
            <h2 style="color: #333; margin-bottom: 20px;">🛒 ตะกร้าสินค้าของคุณ</h2>
            <ul class="cart-items-list" id="cartItemsList">
                </ul>
            <div id="emptyCartMessage" class="empty-cart-message" style="display: none;">ตะกร้าสินค้าว่างเปล่า</div>
            <div class="total-price" id="cartTotalPrice">รวม: ฿0</div>
            <button class="submit-btn" onclick="openCheckoutModal()" id="checkoutButton">ดำเนินการสั่งซื้อ</button>
            <button class="nav-btn" style="margin-top: 10px;" onclick="clearCart()">ล้างตะกร้า</button>
        </div>
    </div>

    <div id="checkoutModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeCheckoutModal()">&times;</span>
            <h2 style="color: #333; margin-bottom: 20px;">📦 ข้อมูลการจัดส่ง</h2>

            <div class="order-summary">
                <h3 style="color: #333;">สรุปคำสั่งซื้อ</h3>
                <ul class="cart-items-list" id="checkoutItemsList">
                    </ul>
                <div class="total-price" id="checkoutTotalPrice">รวม: ฿0</div>
            </div>

            <form id="checkoutForm">
                <div class="form-group">
                    <label>ชื่อ-นามสกุล:</label>
                    <input type="text" id="customerName" required>
                </div>
                <div class="form-group">
                    <label>เบอร์โทรศัพท์:</label>
                    <input type="tel" id="phone" pattern="[0-9]{10}" title="กรุณากรอกเบอร์โทรศัพท์ 10 หลัก" required>
                </div>
                <div class="form-group">
                    <label>อีเมล:</label>
                    <input type="email" id="email" required>
                </div>
                <div class="form-group">
                    <label>ที่อยู่จัดส่ง:</label>
                    <textarea id="address" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label>หมายเหตุ:</label>
                    <textarea id="note" rows="2" placeholder="ข้อมูลเพิ่มเติม (ไม่จำเป็น)"></textarea>
                </div>

                <button type="submit" class="checkout-btn">ยืนยันคำสั่งซื้อ</button>
            </form>

            <div class="loading" id="checkoutLoading">
                <div class="spinner"></div>
                <p>กำลังส่งคำสั่งซื้อ...</p>
            </div>
             <div id="checkoutFormMessage" style="margin-top: 15px;"></div>
        </div>
    </div>


    <script>
        // *** สำคัญมาก: เปลี่ยนค่านี้เป็น URL ที่คุณ Deploy Google Apps Script ของคุณ ***
        const API_URL = 'https://script.google.com/macros/s/AKfycbz7dG_-XLNXF5PWV5pPKdf56bT-LVfPUDBx_gvNLTj8IdE4SQ2crLEHwv1aINozJmKJ/exec';

        let products = []; // สินค้าทั้งหมด
        let categories = []; // หมวดหมู่ทั้งหมด
        let cartItems = []; // ตะกร้าสินค้า
        let isAdminLoggedIn = false;
        let adminToken = null;

        // โหลดข้อมูลเมื่อหน้าเว็บเริ่มต้น
        window.onload = function() {
            loadCategories(); // โหลดหมวดหมู่ก่อน
            loadCartFromLocalStorage(); // โหลดตะกร้าจาก Local Storage
            updateCartCount(); // อัปเดตจำนวนสินค้าในตะกร้า
            // ตรวจสอบสถานะการล็อกอิน Admin จาก Local Storage
            const savedAdminToken = localStorage.getItem('adminToken');
            if (savedAdminToken && savedAdminToken.startsWith('admin_token_')) {
                isAdminLoggedIn = true;
                adminToken = savedAdminToken;
                // หากล็อกอินอยู่แล้ว ให้แสดงหน้า Admin Panel เลย (หากผู้ใช้กดแท็บ Admin)
            }
            showSection('categories-section'); // เริ่มต้นที่หน้าหมวดหมู่
        };

        // ฟังก์ชันเปลี่ยน Section
        function showSection(sectionId, force = false) {
            const sections = document.querySelectorAll('.content-section');
            sections.forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById(sectionId).style.display = 'block';

            const navBtns = document.querySelectorAll('.nav-btn');
            navBtns.forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(sectionId.replace('-section', 'NavBtn')).classList.add('active');

            if (sectionId === 'admin-section' && !isAdminLoggedIn && !force) {
                document.getElementById('admin-login-area').style.display = 'block';
                document.getElementById('admin-panel').style.display = 'none';
            } else if (sectionId === 'admin-section' && isAdminLoggedIn) {
                document.getElementById('admin-login-area').style.display = 'none';
                document.getElementById('admin-panel').style.display = 'block';
                loadAdminData(); // โหลดข้อมูลสำหรับ Admin
            } else if (sectionId === 'products-section') {
                // หากกำลังแสดง Products section ให้ตรวจสอบว่า categories ถูกโหลดแล้ว
                // และทำการโหลดสินค้าทั้งหมดเมื่อเข้าหน้านี้ครั้งแรก หรือเมื่อเปลี่ยนหมวดหมู่
                // แต่เนื่องจากหน้าแรกคือ Categories แล้วคลิกเข้า Product Section, ให้โหลด All Products เสมอ
                 loadProducts('All');
            }
        }

        // ฟังก์ชันโหลดหมวดหมู่
        async function loadCategories() {
            document.getElementById('categories-grid').innerHTML = '';
            document.getElementById('noCategoriesMessage').style.display = 'none';

            try {
                const response = await fetch(`${API_URL}?action=getCategories`);
                const data = await response.json();

                if (data.success) {
                    categories = data.categories;
                    displayCategories();
                    updateCategoryFilterButtons(); // อัปเดตปุ่ม Filter
                } else {
                    console.error('Error loading categories:', data.error);
                    document.getElementById('categories-grid').innerHTML = `<p class="error-message">เกิดข้อผิดพลาดในการโหลดหมวดหมู่: ${data.error}</p>`;
                }
            } catch (error) {
                console.error('Network or parsing error:', error);
                document.getElementById('categories-grid').innerHTML = `<p class="error-message">ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้.</p>`;
            }
        }

        // ฟังก์ชันแสดงหมวดหมู่
        function displayCategories() {
            const categoriesGrid = document.getElementById('categories-grid');
            categoriesGrid.innerHTML = '';

            if (categories.length === 0) {
                document.getElementById('noCategoriesMessage').style.display = 'block';
                return;
            }
            document.getElementById('noCategoriesMessage').style.display = 'none';

            // ตัวอย่างรูปภาพสำหรับหมวดหมู่ (คุณสามารถใช้รูปภาพจริงได้)
            const categoryImages = {
                'เสื้อยืด': 'https://via.placeholder.com/300/a8dadc/1d3557?text=T-Shirt',
                'เสื้อโปโล': 'https://via.placeholder.com/300/457b9d/f1faee?text=Polo+Shirt',
                'กางเกง': 'https://via.placeholder.com/300/1d3557/a8dadc?text=Pants',
                // เพิ่มหมวดหมู่อื่นๆ ที่นี่
            };

            categories.forEach(category => {
                const categoryCard = document.createElement('div');
                categoryCard.classList.add('category-card');
                const categoryImageUrl = categoryImages[category] || 'https://via.placeholder.com/300/cccccc/000000?text=Category';
                categoryCard.innerHTML = `
                    <img src="${categoryImageUrl}" alt="${category}" class="category-image">
                    <div class="category-info">
                        <h3 class="category-name">${category}</h3>
                        <button class="buy-btn" onclick="showProductsByCategory('${category}')">ดูสินค้า</button>
                    </div>
                `;
                categoriesGrid.appendChild(categoryCard);
            });
        }

        // ฟังก์ชันอัปเดตปุ่มฟิลเตอร์หมวดหมู่
        function updateCategoryFilterButtons() {
            const categoryFilter = document.getElementById('categoryFilter');
            // ลบปุ่มหมวดหมู่เก่าออก ยกเว้นปุ่ม "สินค้าทั้งหมด"
            const oldCategoryButtons = categoryFilter.querySelectorAll('.category-filter-btn:not(:first-child)');
            oldCategoryButtons.forEach(btn => btn.remove());

            categories.forEach(category => {
                const btn = document.createElement('button');
                btn.classList.add('category-filter-btn');
                btn.innerText = category;
                btn.onclick = () => loadProducts(category);
                categoryFilter.appendChild(btn);
            });
        }

        // ฟังก์ชันแสดงสินค้าตามหมวดหมู่
        function showProductsByCategory(category) {
            showSection('products-section'); // เปลี่ยนไปหน้า Products
            loadProducts(category); // โหลดสินค้าในหมวดหมู่นั้น
        }


        // ฟังก์ชันโหลดสินค้า
        async function loadProducts(category = 'All') {
            document.getElementById('products-grid').innerHTML = '';
            showLoading(false, 'products-section');
            document.getElementById('noProductsMessage').style.display = 'none';

            // อัปเดต Active State ของปุ่ม Filter
            document.querySelectorAll('.category-filter-btn').forEach(btn => {
                if (btn.innerText.toLowerCase() === category.toLowerCase() || (category === 'All' && btn.innerText === 'สินค้าทั้งหมด')) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            let url = `${API_URL}?action=getProducts`;
            if (category !== 'All') {
                url += `&category=${encodeURIComponent(category)}`;
            }

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data.success) {
                    products = data.products; // อัปเดต global products list
                    displayProducts();
                } else {
                    console.error('Error loading products:', data.error);
                    document.getElementById('products-grid').innerHTML = `<p class="error-message">เกิดข้อผิดพลาดในการโหลดสินค้า: ${data.error}</p>`;
                }
            } catch (error) {
                console.error('Network or parsing error:', error);
                document.getElementById('products-grid').innerHTML = `<p class="error-message">ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้. โปรดตรวจสอบการเชื่อมต่ออินเทอร์เน็ต.</p>`;
            }
        }

        // ฟังก์ชันแสดงสินค้าในหน้าหลัก
        function displayProducts() {
            const productsGrid = document.getElementById('products-grid');
            productsGrid.innerHTML = '';

            if (products.length === 0) {
                document.getElementById('noProductsMessage').style.display = 'block';
                return;
            }
            document.getElementById('noProductsMessage').style.display = 'none';

            products.forEach(product => {
                const productCard = document.createElement('div');
                productCard.classList.add('product-card');
                productCard.innerHTML = `
                    <img src="${product.image}" alt="${product.name}" class="product-image">
                    <div class="product-info">
                        <h3 class="product-name">${product.name}</h3>
                        <p class="product-details">ขนาด: ${product.size}</p>
                        <p class="product-details">สี: ${product.color}</p>
                        <p class="product-details">สต็อก: ${product.stock}</p>
                        <p class="product-details">${product.description}</p>
                        <div class="product-price">฿${parseFloat(product.price).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                        <button class="add-to-cart-btn" onclick="openProductDetailsModal(${product.id})">เพิ่มลงตะกร้า</button>
                    </div>
                `;
                productsGrid.appendChild(productCard);
            });
        }

        // === Cart System ===

        let currentProductForModal = null; // เก็บ product ที่เลือกสำหรับ modal

        function openProductDetailsModal(productId) {
            currentProductForModal = products.find(p => p.id == productId);
            if (currentProductForModal) {
                document.getElementById('modalProductName').innerText = currentProductForModal.name;
                document.getElementById('modalProductImage').src = currentProductForModal.image;
                document.getElementById('modalProductDescription').innerText = currentProductForModal.description;
                document.getElementById('modalProductStock').innerText = `เหลือในสต็อก: ${currentProductForModal.stock} ชิ้น`;
                document.getElementById('modalQuantity').value = 1;

                const sizeSelect = document.getElementById('modalProductSize');
                sizeSelect.innerHTML = '';
                const sizes = currentProductForModal.size.split(',').map(s => s.trim());
                sizes.forEach(size => {
                    const option = document.createElement('option');
                    option.value = size;
                    option.innerText = size;
                    sizeSelect.appendChild(option);
                });

                updateModalTotalPrice();
                document.getElementById('productDetailsModal').style.display = 'block';
                document.getElementById('productDetailsMessage').innerHTML = ''; // Clear messages
            } else {
                alert('ไม่พบข้อมูลสินค้า');
            }
        }

        function closeProductDetailsModal() {
            document.getElementById('productDetailsModal').style.display = 'none';
        }

        function changeModalQuantity(delta) {
            let quantityInput = document.getElementById('modalQuantity');
            let currentQuantity = parseInt(quantityInput.value);
            let newQuantity = currentQuantity + delta;

            if (newQuantity < 1) newQuantity = 1;
            if (currentProductForModal && newQuantity > parseInt(currentProductForModal.stock)) {
                alert(`สินค้าในสต็อกมีเพียง ${currentProductForModal.stock} ชิ้น`);
                newQuantity = parseInt(currentProductForModal.stock);
            }

            quantityInput.value = newQuantity;
            updateModalTotalPrice();
        }

        function updateModalTotalPrice() {
            const quantity = parseInt(document.getElementById('modalQuantity').value);
            const price = parseFloat(currentProductForModal.price);
            const total = quantity * price;
            document.getElementById('modalProductPriceTotal').innerText = `฿${total.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }

        function addToCart() {
            const quantity = parseInt(document.getElementById('modalQuantity').value);
            const selectedSize = document.getElementById('modalProductSize').value;

            if (quantity <= 0 || !selectedSize) {
                displayMessage('error', 'กรุณาระบุจำนวนและขนาดที่ถูกต้อง', 'productDetailsMessage');
                return;
            }
            if (quantity > parseInt(currentProductForModal.stock)) {
                displayMessage('error', `สินค้าในสต็อกมีเพียง ${currentProductForModal.stock} ชิ้น`, 'productDetailsMessage');
                return;
            }

            // Check if item with same ID and size already in cart
            const existingItemIndex = cartItems.findIndex(item =>
                item.id === currentProductForModal.id && item.size === selectedSize
            );

            if (existingItemIndex > -1) {
                // Update quantity if exists
                const existingItem = cartItems[existingItemIndex];
                if (existingItem.quantity + quantity > parseInt(currentProductForModal.stock)) {
                    displayMessage('error', `เพิ่มไม่ได้, สินค้าในสต็อกไม่พอสำหรับจำนวนรวม ${existingItem.quantity + quantity} ชิ้น`, 'productDetailsMessage');
                    return;
                }
                existingItem.quantity += quantity;
            } else {
                // Add new item to cart
                cartItems.push({
                    id: currentProductForModal.id,
                    name: currentProductForModal.name,
                    price: parseFloat(currentProductForModal.price),
                    image: currentProductForModal.image,
                    size: selectedSize,
                    quantity: quantity,
                    stock: parseInt(currentProductForModal.stock) // เก็บ stock เพื่อเช็คตอนเพิ่ม
                });
            }

            saveCartToLocalStorage();
            updateCartCount();
            displayMessage('success', `${currentProductForModal.name} (ขนาด ${selectedSize}, จำนวน ${quantity}) ถูกเพิ่มลงตะกร้าแล้ว!`, 'productDetailsMessage');
            setTimeout(closeProductDetailsModal, 1500); // ปิด modal หลังจาก 1.5 วินาที
        }

        function saveCartToLocalStorage() {
            localStorage.setItem('cartItems', JSON.stringify(cartItems));
        }

        function loadCartFromLocalStorage() {
            const savedCart = localStorage.getItem('cartItems');
            if (savedCart) {
                cartItems = JSON.parse(savedCart);
            }
        }

        function updateCartCount() {
            const totalItems = cartItems.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('cartCount').innerText = totalItems;
        }

        function openCartModal() {
            displayCartItems();
            document.getElementById('cartModal').style.display = 'block';
        }

        function closeCartModal() {
            document.getElementById('cartModal').style.display = 'none';
        }

        function displayCartItems() {
            const cartList = document.getElementById('cartItemsList');
            cartList.innerHTML = '';
            let totalCartPrice = 0;

            if (cartItems.length === 0) {
                document.getElementById('emptyCartMessage').style.display = 'block';
                document.getElementById('checkoutButton').disabled = true;
            } else {
                document.getElementById('emptyCartMessage').style.display = 'none';
                document.getElementById('checkoutButton').disabled = false;

                cartItems.forEach((item, index) => {
                    const listItem = document.createElement('li');
                    listItem.classList.add('cart-item');
                    listItem.innerHTML = `
                        <div class="cart-item-info">
                            <div class="cart-item-name">${item.name} (ขนาด: ${item.size})</div>
                            <div class="cart-item-price">฿${item.price.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                        </div>
                        <div class="cart-item-controls">
                            <button class="quantity-btn" onclick="changeCartItemQuantity(${index}, -1)">-</button>
                            <input type="number" value="${item.quantity}" min="1" class="cart-item-quantity-input" onchange="updateCartItemQuantityManual(${index}, this.value)">
                            <button class="quantity-btn" onclick="changeCartItemQuantity(${index}, 1)">+</button>
                            <button class="remove-item-btn" onclick="removeCartItem(${index})">ลบ</button>
                        </div>
                    `;
                    cartList.appendChild(listItem);
                    totalCartPrice += item.quantity * item.price;
                });
            }
            document.getElementById('cartTotalPrice').innerText = `รวม: ฿${totalCartPrice.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }

        function changeCartItemQuantity(index, delta) {
            let item = cartItems[index];
            let newQuantity = item.quantity + delta;

            if (newQuantity < 1) newQuantity = 1;
            if (newQuantity > item.stock) { // ใช้ stock ที่เก็บไว้ใน item
                alert(`สินค้า ${item.name} (ขนาด ${item.size}) มีในสต็อกเพียง ${item.stock} ชิ้น`);
                newQuantity = item.stock;
            }

            item.quantity = newQuantity;
            saveCartToLocalStorage();
            updateCartCount();
            displayCartItems();
        }

        function updateCartItemQuantityManual(index, value) {
            let item = cartItems[index];
            let newQuantity = parseInt(value);

            if (isNaN(newQuantity) || newQuantity < 1) newQuantity = 1;
            if (newQuantity > item.stock) {
                alert(`สินค้า ${item.name} (ขนาด ${item.size}) มีในสต็อกเพียง ${item.stock} ชิ้น`);
                newQuantity = item.stock;
            }

            item.quantity = newQuantity;
            saveCartToLocalStorage();
            updateCartCount();
            displayCartItems();
        }

        function removeCartItem(index) {
            if (confirm('คุณต้องการลบสินค้าชิ้นนี้ออกจากตะกร้าหรือไม่?')) {
                cartItems.splice(index, 1);
                saveCartToLocalStorage();
                updateCartCount();
                displayCartItems();
            }
        }

        function clearCart() {
            if (confirm('คุณต้องการล้างตะกร้าสินค้าทั้งหมดหรือไม่?')) {
                cartItems = [];
                saveCartToLocalStorage();
                updateCartCount();
                displayCartItems();
            }
        }

        function openCheckoutModal() {
            closeCartModal(); // ปิดตะกร้า
            // แสดงสรุปรายการใน Checkout Modal
            const checkoutList = document.getElementById('checkoutItemsList');
            checkoutList.innerHTML = '';
            let totalCheckoutPrice = 0;

            cartItems.forEach(item => {
                const listItem = document.createElement('li');
                listItem.innerHTML = `
                    <div style="display: flex; justify-content: space-between;">
                        <span>${item.name} (ขนาด: ${item.size}) x ${item.quantity}</span>
                        <span>฿${(item.quantity * item.price).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
                    </div>
                `;
                checkoutList.appendChild(listItem);
                totalCheckoutPrice += item.quantity * item.price;
            });
            document.getElementById('checkoutTotalPrice').innerText = `รวม: ฿${totalCheckoutPrice.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

            document.getElementById('checkoutModal').style.display = 'block';
            document.getElementById('checkoutFormMessage').innerHTML = ''; // Clear messages
        }

        function closeCheckoutModal() {
            document.getElementById('checkoutModal').style.display = 'none';
        }

        // ฟังก์ชันส่งคำสั่งซื้อจาก Checkout Modal
        document.getElementById('checkoutForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            showLoading(true, 'checkout');
            document.getElementById('checkoutFormMessage').innerHTML = '';

            const customerName = document.getElementById('customerName').value;
            const phone = document.getElementById('phone').value;
            const email = document.getElementById('email').value;
            const address = document.getElementById('address').value;
            const totalAmount = parseFloat(document.getElementById('checkoutTotalPrice').innerText.replace('รวม: ฿', '').replace(/,/g, ''));

            if (cartItems.length === 0) {
                displayMessage('error', 'ตะกร้าสินค้าว่างเปล่า ไม่สามารถสั่งซื้อได้', 'checkoutFormMessage');
                showLoading(false, 'checkout');
                return;
            }

            const params = new URLSearchParams();
            params.append('action', 'createOrder');
            params.append('customerName', customerName);
            params.append('phone', phone);
            params.append('email', email);
            params.append('address', address);
            params.append('cartItems', JSON.stringify(cartItems)); // ส่งตะกร้าสินค้าเป็น JSON string
            params.append('total', totalAmount);

            try {
                const response = await fetch(`${API_URL}?${params.toString()}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: params.toString()
                });
                const data = await response.json();

                if (data.success) {
                    displayMessage('success', `สั่งซื้อสำเร็จ! หมายเลขคำสั่งซื้อของคุณคือ: ${data.orderId}`, 'checkoutFormMessage');
                    document.getElementById('checkoutForm').reset();
                    cartItems = []; // ล้างตะกร้า
                    saveCartToLocalStorage();
                    updateCartCount();
                    setTimeout(() => {
                        closeCheckoutModal();
                        loadProducts('All'); // กลับไปโหลดสินค้าทั้งหมดใหม่ (เพื่ออัปเดตสต็อกถ้ามี)
                    }, 2000);
                } else {
                    displayMessage('error', `เกิดข้อผิดพลาดในการสั่งซื้อ: ${data.error}`, 'checkoutFormMessage');
                }
            } catch (error) {
                console.error('Network or parsing error:', error);
                displayMessage('error', 'ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้. โปรดตรวจสอบการเชื่อมต่ออินเทอร์เน็ต.', 'checkoutFormMessage');
            } finally {
                showLoading(false, 'checkout');
            }
        });


        // ฟังก์ชันตรวจสอบสถานะคำสั่งซื้อ
        async function checkOrderStatus() {
            const orderId = document.getElementById('orderIdInput').value.trim();
            const orderStatusResult = document.getElementById('orderStatusResult');
            orderStatusResult.innerHTML = '';
            document.getElementById('orderStatusLoading').style.display = 'block';

            if (!orderId) {
                displayMessage('error', 'กรุณากรอกหมายเลขคำสั่งซื้อ', 'orderStatusResult');
                document.getElementById('orderStatusLoading').style.display = 'none';
                return;
            }

            try {
                const response = await fetch(`${API_URL}?action=getOrderById&orderId=${orderId}`);
                const data = await response.json();

                if (data.success && data.order) {
                    const order = data.order;
                    let itemsHtml = '';
                    // cartitemsjson จะถูก parse เป็น array ของ object แล้วใน backend
                    if (Array.isArray(order.cartitemsjson)) {
                        order.cartitemsjson.forEach(item => {
                            itemsHtml += `<li>${item.name} (ขนาด: ${item.size}, จำนวน: ${item.quantity}, ราคา: ${item.price} บาท)</li>`;
                        });
                    } else {
                        itemsHtml = '<li>ไม่พบรายละเอียดสินค้า</li>';
                    }

                    orderStatusResult.innerHTML = `
                        <div class="success-message">
                            <h3>รายละเอียดคำสั่งซื้อ ${order.orderid}</h3>
                            <p><strong>ชื่อลูกค้า:</strong> ${order.customername}</p>
                            <p><strong>เบอร์โทรศัพท์:</strong> ${order.phone}</p>
                            <p><strong>อีเมล:</strong> ${order.email}</p>
                            <p><strong>ที่อยู่:</strong> ${order.address}</p>
                            <p><strong>รายการสินค้า:</strong></p>
                            <ul>${itemsHtml}</ul>
                            <p><strong>ยอดรวม:</strong> ฿${parseFloat(order.total).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</p>
                            <p><strong>สถานะ:</strong> <strong style="color: ${getOrderStatusColor(order.status)};">${order.status}</strong></p>
                            <p><strong>วันที่สั่งซื้อ:</strong> ${order.date}</p>
                        </div>
                    `;
                } else {
                    displayMessage('error', `ไม่พบคำสั่งซื้อหมายเลข ${orderId}`, 'orderStatusResult');
                }
            } catch (error) {
                console.error('Network or parsing error:', error);
                displayMessage('error', 'ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้. โปรดลองใหม่อีกครั้ง.', 'orderStatusResult');
            } finally {
                document.getElementById('orderStatusLoading').style.display = 'none';
            }
        }

        // ฟังก์ชันแสดง/ซ่อน Loading Spinner
        function showLoading(show, section = null) {
            if (section === 'productDetailsModal') {
                document.getElementById('productDetailsLoading').style.display = show ? 'block' : 'none';
                document.getElementById('productDetailsModal').querySelector('form').style.display = show ? 'none' : 'block';
            } else if (section === 'checkout') {
                document.getElementById('checkoutLoading').style.display = show ? 'block' : 'none';
                document.getElementById('checkoutForm').style.display = show ? 'none' : 'block';
            } else if (section === 'adminLogin') {
                document.getElementById('adminLoginLoading').style.display = show ? 'block' : 'none';
                document.getElementById('adminUsername').disabled = show;
                document.getElementById('adminPassword').disabled = show;
                document.querySelector('#admin-login-area button').disabled = show;
            } else if (section === 'productForm') {
                document.getElementById('productFormLoading').style.display = show ? 'block' : 'none';
                document.getElementById('productEntryForm').style.display = show ? 'none' : 'block';
            } else if (section === 'orderStatus') {
                document.getElementById('orderStatusLoading').style.display = show ? 'block' : 'none';
            }
        }

        // ฟังก์ชันแสดงข้อความสำเร็จ/ข้อผิดพลาด
        function displayMessage(type, message, elementId) {
            const messageElement = document.getElementById(elementId);
            messageElement.innerHTML = `<div class="${type}-message">${message}</div>`;
        }

        // ฟังก์ชันสำหรับ Admin Login
        async function adminLogin() {
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;
            document.getElementById('adminLoginMessage').innerHTML = '';
            showLoading(true, 'adminLogin');

            const params = new URLSearchParams();
            params.append('action', 'adminLogin');
            params.append('username', username);
            params.append('password', password);

            try {
                const response = await fetch(`${API_URL}?${params.toString()}`);
                const data = await response.json();

                if (data.success) {
                    isAdminLoggedIn = true;
                    adminToken = data.token;
                    localStorage.setItem('adminToken', adminToken);
                    displayMessage('success', 'เข้าสู่ระบบสำเร็จ!', 'adminLoginMessage');
                    setTimeout(() => {
                        showSection('admin-section', true); // แสดง Admin Panel
                    }, 500);
                } else {
                    displayMessage('error', data.message, 'adminLoginMessage');
                }
            } catch (error) {
                console.error('Login error:', error);
                displayMessage('error', 'เกิดข้อผิดพลาดในการเชื่อมต่อ. โปรดลองใหม่อีกครั้ง.', 'adminLoginMessage');
            } finally {
                showLoading(false, 'adminLogin');
            }
        }

        // ฟังก์ชันสำหรับ Admin Logout
        function adminLogout() {
            isAdminLoggedIn = false;
            adminToken = null;
            localStorage.removeItem('adminToken');
            alert('ออกจากระบบสำเร็จ');
            showSection('admin-section');
        }

        // ฟังก์ชันโหลดข้อมูลสำหรับ Admin (สินค้าและคำสั่งซื้อ)
        async function loadAdminData() {
            await loadAdminProducts();
            await loadAdminOrders();
        }

        // โหลดสินค้าสำหรับ Admin
        async function loadAdminProducts() {
            const adminProductTableBody = document.getElementById('adminProductTableBody');
            adminProductTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">กำลังโหลดสินค้า...</td></tr>';
            document.getElementById('noAdminProductsMessage').style.display = 'none';

            try {
                const response = await fetch(`${API_URL}?action=getProducts`);
                const data = await response.json();

                adminProductTableBody.innerHTML = '';

                if (data.success && data.products.length > 0) {
                    products = data.products; // อัปเดต products array ด้วยข้อมูลล่าสุด
                    products.forEach(product => {
                        const row = adminProductTableBody.insertRow();
                        row.innerHTML = `
                            <td>${product.id}</td>
                            <td>${product.name}</td>
                            <td>฿${parseFloat(product.price).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                            <td>${product.stock}</td>
                            <td>${product.category || '-'}</td>
                            <td class="admin-actions">
                                <button class="edit-btn" onclick="editProduct(${product.id})">แก้ไข</button>
                                <button class="delete-btn" onclick="deleteProduct(${product.id})">ลบ</button>
                            </td>
                        `;
                    });
                } else if (data.success && data.products.length === 0) {
                    document.getElementById('noAdminProductsMessage').style.display = 'block';
                } else {
                    adminProductTableBody.innerHTML = `<tr><td colspan="6" class="error-message">Error: ${data.error}</td></tr>`;
                }
            } catch (error) {
                console.error('Error loading admin products:', error);
                adminProductTableBody.innerHTML = `<tr><td colspan="6" class="error-message">Network error loading products.</td></tr>`;
            }
        }

        // โหลดคำสั่งซื้อสำหรับ Admin
        async function loadAdminOrders() {
            const adminOrderTableBody = document.getElementById('adminOrderTableBody');
            adminOrderTableBody.innerHTML = '<tr><td colspan="7" style="text-align: center;">กำลังโหลดคำสั่งซื้อ...</td></tr>';
            document.getElementById('noAdminOrdersMessage').style.display = 'none';

            try {
                const response = await fetch(`${API_URL}?action=getOrders`);
                const data = await response.json();

                adminOrderTableBody.innerHTML = '';

                if (data.success && data.orders.length > 0) {
                    // orders = data.orders; // Store orders globally if needed
                    data.orders.forEach(order => {
                        let productSummary = '';
                        if (Array.isArray(order.cartitemsjson)) {
                            productSummary = order.cartitemsjson.map(item => `${item.name} (x${item.quantity})`).join(', ');
                        } else {
                            productSummary = 'N/A'; // กรณีไม่สามารถ parse ได้
                        }

                        const row = adminOrderTableBody.insertRow();
                        row.innerHTML = `
                            <td>${order.orderid}</td>
                            <td>${order.customername}</td>
                            <td>${productSummary}</td>
                            <td>฿${parseFloat(order.total).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                            <td style="color: ${getOrderStatusColor(order.status)};"><strong>${order.status}</strong></td>
                            <td>${order.date}</td>
                            <td class="admin-actions">
                                <select onchange="updateOrderStatus('${order.orderid}', this.value)">
                                    <option value="รอการชำระเงิน" ${order.status === 'รอการชำระเงิน' ? 'selected' : ''}>รอการชำระเงิน</option>
                                    <option value="ชำระเงินแล้ว" ${order.status === 'ชำระเงินแล้ว' ? 'selected' : ''}>ชำระเงินแล้ว</option>
                                    <option value="กำลังจัดส่ง" ${order.status === 'กำลังจัดส่ง' ? 'selected' : ''}>กำลังจัดส่ง</option>
                                    <option value="จัดส่งสำเร็จ" ${order.status === 'จัดส่งสำเร็จ' ? 'selected' : ''}>จัดส่งสำเร็จ</option>
                                    <option value="ยกเลิก" ${order.status === 'ยกเลิก' ? 'selected' : ''}>ยกเลิก</option>
                                </select>
                            </td>
                        `;
                    });
                } else if (data.success && data.orders.length === 0) {
                     document.getElementById('noAdminOrdersMessage').style.display = 'block';
                }
                else {
                    adminOrderTableBody.innerHTML = `<tr><td colspan="7" class="error-message">Error: ${data.error}</td></tr>`;
                }
            } catch (error) {
                console.error('Error loading admin orders:', error);
                adminOrderTableBody.innerHTML = `<tr><td colspan="7" class="error-message">Network error loading orders.</td></tr>`;
            }
        }

        // ฟังก์ชันกำหนดสีตามสถานะ Order
        function getOrderStatusColor(status) {
            switch (status) {
                case 'รอการชำระเงิน': return '#f39c12';
                case 'ชำระเงินแล้ว': return '#27ae60';
                case 'กำลังจัดส่ง': return '#3498db';
                case 'จัดส่งสำเร็จ': return '#2ecc71';
                case 'ยกเลิก': return '#e74c3c';
                default: return '#333';
            }
        }

        // ฟังก์ชันแสดงฟอร์มเพิ่มสินค้า
        function showAddProductForm() {
            document.getElementById('addProductForm').style.display = 'block';
            document.getElementById('productEntryForm').reset();
            document.getElementById('productId').value = '';
            document.getElementById('submitProductBtn').innerText = 'เพิ่มสินค้า';
            document.getElementById('addProductForm').querySelector('h3').innerText = 'เพิ่มสินค้าใหม่';
            document.getElementById('productFormMessage').innerHTML = '';
        }

        // ฟังก์ชันแก้ไขสินค้า
        function editProduct(productId) {
            const productToEdit = products.find(p => p.id == productId);
            if (productToEdit) {
                document.getElementById('addProductForm').style.display = 'block';
                document.getElementById('addProductForm').querySelector('h3').innerText = 'แก้ไขสินค้า';
                document.getElementById('productId').value = productToEdit.id;
                document.getElementById('productName').value = productToEdit.name;
                document.getElementById('productPrice').value = parseFloat(productToEdit.price);
                document.getElementById('productImage').value = productToEdit.image;
                document.getElementById('productSize').value = productToEdit.size;
                document.getElementById('productColor').value = productToEdit.color;
                document.getElementById('productStock').value = parseInt(productToEdit.stock);
                document.getElementById('productDescription').value = productToEdit.description;
                document.getElementById('productCategory').value = productToEdit.category;
                document.getElementById('submitProductBtn').innerText = 'บันทึกการแก้ไข';
                document.getElementById('productFormMessage').innerHTML = '';
            }
        }

        // ฟังก์ชันยกเลิกการเพิ่ม/แก้ไขสินค้า
        function cancelProductEdit() {
            document.getElementById('addProductForm').style.display = 'none';
        }

        // ฟังก์ชัน Add/Update Product (ใช้ฟอร์มเดียวกัน)
        document.getElementById('productEntryForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            showLoading(true, 'productForm');
            document.getElementById('productFormMessage').innerHTML = '';

            const productId = document.getElementById('productId').value;
            const isEditing = !!productId;
            const action = isEditing ? 'updateProduct' : 'addProduct';

            const params = new URLSearchParams();
            params.append('action', action);
            if (isEditing) {
                params.append('id', productId);
            }
            params.append('name', document.getElementById('productName').value);
            params.append('price', document.getElementById('productPrice').value);
            params.append('image', document.getElementById('productImage').value);
            params.append('size', document.getElementById('productSize').value);
            params.append('color', document.getElementById('productColor').value);
            params.append('stock', document.getElementById('productStock').value);
            params.append('description', document.getElementById('productDescription').value);
            params.append('category', document.getElementById('productCategory').value);

            try {
                const response = await fetch(`${API_URL}?${params.toString()}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: params.toString()
                });
                const data = await response.json();

                if (data.success) {
                    displayMessage('success', data.message, 'productFormMessage');
                    document.getElementById('productEntryForm').reset();
                    document.getElementById('addProductForm').style.display = 'none';
                    loadAdminProducts(); // โหลดข้อมูลสินค้าใหม่สำหรับ Admin
                    loadProducts('All'); // อัปเดตสินค้าในหน้าหลัก
                    loadCategories(); // อัปเดตหมวดหมู่
                } else {
                    displayMessage('error', data.error, 'productFormMessage');
                }
            }
            catch (error) {
                console.error('Product action error:', error);
                displayMessage('error', 'ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้. โปรดลองใหม่อีกครั้ง.', 'productFormMessage');
            } finally {
                showLoading(false, 'productForm');
            }
        });

        // ฟังก์ชันลบสินค้า
        async function deleteProduct(productId) {
            if (!confirm(`คุณแน่ใจหรือไม่ที่ต้องการลบสินค้า ID: ${productId}?`)) {
                return;
            }

            const params = new URLSearchParams();
            params.append('action', 'deleteProduct');
            params.append('id', productId);

            try {
                const response = await fetch(`${API_URL}?${params.toString()}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: params.toString()
                });
                const data = await response.json();

                if (data.success) {
                    alert('ลบสินค้าสำเร็จ!');
                    loadAdminProducts();
                    loadProducts('All');
                    loadCategories();
                } else {
                    alert(`เกิดข้อผิดพลาดในการลบ: ${data.error}`);
                }
            } catch (error) {
                console.error('Delete product error:', error);
                alert('ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้. โปรดลองใหม่อีกครั้ง.');
            }
        }

        // ฟังก์ชันอัปเดตสถานะคำสั่งซื้อ (สำหรับ Admin)
        async function updateOrderStatus(orderId, status) {
            if (!confirm(`คุณแน่ใจหรือไม่ที่ต้องการเปลี่ยนสถานะ Order ID: ${orderId} เป็น "${status}"?`)) {
                return;
            }

            const params = new URLSearchParams();
            params.append('action', 'updateOrderStatus');
            params.append('orderId', orderId);
            params.append('status', status);

            try {
                const response = await fetch(`${API_URL}?${params.toString()}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: params.toString()
                });
                const data = await response.json();

                if (data.success) {
                    alert('อัปเดตสถานะคำสั่งซื้อสำเร็จ!');
                    loadAdminOrders();
                } else {
                    alert(`เกิดข้อผิดพลาดในการอัปเดตสถานะ: ${data.error}`);
                }
            } catch (error) {
                console.error('Update order status error:', error);
                alert('ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้. โปรดลองใหม่อีกครั้ง.');
            }
        }
    </script>
</body>
</html>
