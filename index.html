<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ร้านเสื้อออนไลน์</title>
    <!-- เพิ่ม Google Fonts - Kanit -->
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* CSS ทั่วไป */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Kanit', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .nav-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .nav-buttons button {
            background-color: #ff6f61;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .nav-buttons button:hover {
            background-color: #e65c50;
            transform: translateY(-2px);
        }

        /* Product List */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            background: rgba(255, 255, 255, 0.2);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(8px);
        }

        .product-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            flex-direction: column;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .product-card img {
            width: 100%;
            height: 250px;
            object-fit: cover;
            border-bottom: 1px solid #eee;
        }

        .product-info {
            padding: 15px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .product-info h3 {
            font-size: 1.4em;
            margin-bottom: 8px;
            color: #333;
        }

        .product-info p {
            font-size: 0.95em;
            color: #555;
            margin-bottom: 5px;
        }

        .product-price {
            font-size: 1.3em;
            font-weight: 600;
            color: #ff6f61;
            margin-top: 10px;
        }

        .add-to-cart-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            margin-top: 15px;
            transition: background-color 0.3s ease;
            align-self: flex-start; /* Align button to start */
        }

        .add-to-cart-btn:hover {
            background-color: #45a049;
        }

        /* Cart Section */
        .cart-section {
            background: white;
            padding: 25px;
            margin-top: 30px;
            border-radius: 15px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
            max-height: 80vh; /* Limit height */
            overflow-y: auto; /* Enable scrolling */
        }

        .cart-section h2 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        #cart-items {
            list-style: none;
            padding: 0;
            margin-bottom: 20px;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px dashed #eee;
        }

        .cart-item:last-child {
            border-bottom: none;
        }

        .cart-item-details {
            flex-grow: 1;
        }

        .cart-item-details h4 {
            font-size: 1.1em;
            color: #333;
        }

        .cart-item-details p {
            font-size: 0.9em;
            color: #777;
        }

        .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quantity-btn {
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            padding: 5px 8px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            min-width: 30px;
            text-align: center;
        }

        .quantity-btn:hover {
            background-color: #e0e0e0;
        }

        .remove-item-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .remove-item-btn:hover {
            background-color: #c82333;
        }

        #cart-total {
            font-size: 1.5em;
            font-weight: 600;
            text-align: right;
            margin-top: 20px;
            color: #ff6f61;
        }

        .checkout-btn {
            display: block;
            width: 100%;
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            margin-top: 20px;
            transition: background-color 0.3s ease;
        }

        .checkout-btn:hover {
            background-color: #0056b3;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.5); /* Black w/ opacity */
            backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 700px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            position: relative;
            animation: fadeIn 0.3s ease-out;
            max-height: 90vh;
            overflow-y: auto;
        }

        .close-button {
            color: #aaa;
            position: absolute;
            top: 15px;
            right: 25px;
            font-size: 35px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .close-button:hover,
        .close-button:focus {
            color: #333;
            text-decoration: none;
        }

        .modal-body {
            display: flex;
            gap: 20px;
            flex-wrap: wrap; /* Allow wrapping on small screens */
        }

        .modal-image {
            flex: 1;
            min-width: 250px;
        }

        .modal-image img {
            width: 100%;
            height: auto;
            border-radius: 8px;
        }

        .modal-details {
            flex: 2;
            min-width: 300px;
        }

        .modal-details h2 {
            font-size: 2em;
            margin-bottom: 10px;
            color: #333;
        }

        .modal-details p {
            margin-bottom: 8px;
            color: #555;
            line-height: 1.6;
        }

        .modal-details .price {
            font-size: 1.8em;
            font-weight: 600;
            color: #ff6f61;
            margin-top: 15px;
        }

        .modal-details .stock {
            font-size: 1em;
            color: #777;
            margin-bottom: 15px;
        }

        .modal-details select,
        .modal-details input[type="number"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }

        .modal-details .add-to-cart-btn {
            width: 100%;
            margin-top: 0; /* Override default margin */
        }

        /* Checkout Form & Payment Form */
        .checkout-section, .payment-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
            max-width: 600px;
            margin: 30px auto;
        }

        .checkout-section h2, .payment-section h2 {
            text-align: center;
            margin-bottom: 25px;
            color: #333;
            font-size: 2em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group input[type="tel"],
        .form-group input[type="number"],
        .form-group input[type="date"],
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            box-sizing: border-box; /* Include padding in width */
        }

        .form-group input[type="file"] {
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 8px;
            width: 100%;
            box-sizing: border-box;
        }

        .submit-btn {
            display: block;
            width: 100%;
            background-color: #28a745;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2em;
            margin-top: 25px;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .submit-btn:hover {
            background-color: #218838;
            transform: translateY(-2px);
        }

        .submit-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        /* Loading Spinner */
        .loading {
            display: none;
            text-align: center;
            margin-top: 20px;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #007bff;
            animation: spin 1s ease infinite;
            margin: 0 auto 10px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-weight: 600;
        }

        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .modal-body {
                flex-direction: column;
            }
            .modal-details {
                min-width: unset;
            }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ร้านเสื้อออนไลน์</h1>
            <p>เลือกซื้อเสื้อผ้าแฟชั่นคุณภาพดี</p>
            <div class="nav-buttons">
                <button onclick="showSection('product-list-section')">สินค้า</button>
                <button onclick="showSection('cart-section')">ตะกร้าสินค้า</button>
                <button onclick="showSection('checkout-section')">สั่งซื้อ</button>
                <button onclick="showSection('payment-section')">แจ้งชำระเงิน</button>
            </div>
        </div>

        <!-- Product List Section -->
        <div id="product-list-section" class="product-list-section">
            <div class="product-grid" id="product-grid">
                <!-- Products will be loaded here by JavaScript -->
            </div>
        </div>

        <!-- Cart Section -->
        <div id="cart-section" class="cart-section" style="display: none;">
            <h2>ตะกร้าสินค้าของคุณ</h2>
            <ul id="cart-items">
                <!-- Cart items will be loaded here by JavaScript -->
                <li style="text-align: center; color: #777;" id="empty-cart-message">ตะกร้าสินค้าว่างเปล่า</li>
            </ul>
            <p id="cart-total" style="display: none;">ยอดรวม: <span id="total-amount">0</span> บาท</p>
            <button id="proceed-to-checkout-btn" class="checkout-btn" style="display: none;">ดำเนินการสั่งซื้อ</button>
        </div>

        <!-- Checkout Section (Modal) -->
        <div id="checkout-section" class="checkout-section" style="display: none;">
            <h2>ข้อมูลจัดส่ง</h2>
            <form id="checkoutForm">
                <div class="form-group">
                    <label for="checkoutCustomerName">ชื่อ-นามสกุล:</label>
                    <input type="text" id="checkoutCustomerName" required>
                </div>
                <div class="form-group">
                    <label for="checkoutPhone">เบอร์โทรศัพท์:</label>
                    <input type="tel" id="checkoutPhone" required>
                </div>
                <div class="form-group">
                    <label for="checkoutEmail">อีเมล:</label>
                    <input type="email" id="checkoutEmail" required>
                </div>
                <div class="form-group">
                    <label for="checkoutAddress">ที่อยู่จัดส่ง:</label>
                    <textarea id="checkoutAddress" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label for="checkoutNote">หมายเหตุ:</label>
                    <textarea id="checkoutNote" rows="2" placeholder="ข้อมูลเพิ่มเติม (ไม่จำเป็น)"></textarea>
                </div>
                
                <button type="submit" class="submit-btn">สั่งซื้อเลย</button>
            </form>

            <div class="loading" id="checkoutLoading">
                <div class="spinner"></div>
                <p>กำลังส่งคำสั่งซื้อ...</p>
            </div>
            <div class="message" id="checkoutMessage"></div>
        </div>

        <!-- Payment Confirmation Section -->
        <div id="payment-section" class="payment-section" style="display: none;">
            <h2>แจ้งชำระเงิน</h2>
            <form id="paymentForm">
                <div class="form-group">
                    <label for="paymentConfirmOrderId">หมายเลขคำสั่งซื้อ:</label>
                    <input type="text" id="paymentConfirmOrderId" required>
                </div>
                <div class="form-group">
                    <label for="payerName">ชื่อผู้โอน:</label>
                    <input type="text" id="payerName" required>
                </div>
                <div class="form-group">
                    <label for="payerBank">ธนาคารที่โอน:</label>
                    <input type="text" id="payerBank" required>
                </div>
                <div class="form-group">
                    <label for="amountPaid">จำนวนเงินที่โอน:</label>
                    <input type="number" id="amountPaid" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="paymentDate">วันที่โอน:</label>
                    <input type="date" id="paymentDate" required>
                </div>
                <div class="form-group">
                    <label for="paymentSlip">สลิปโอนเงิน:</label>
                    <input type="file" id="paymentSlip" accept="image/*" required>
                </div>
                <button type="submit" class="submit-btn">ยืนยันการชำระเงิน</button>
            </form>
            <div class="loading" id="paymentLoading">
                <div class="spinner"></div>
                <p>กำลังส่งหลักฐานการชำระเงิน...</p>
            </div>
            <div class="message" id="paymentMessage"></div>
        </div>
    </div>

    <!-- Product Details Modal -->
    <div id="productModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-button" onclick="closeProductModal()">&times;</span>
            <div class="modal-body">
                <div class="modal-image">
                    <img id="modalProductImage" src="" alt="Product Image">
                </div>
                <div class="modal-details">
                    <h2 id="modalProductName"></h2>
                    <p><strong>หมวดหมู่:</strong> <span id="modalProductCategory"></span></p>
                    <p><strong>สี:</strong> <span id="modalProductColor"></span></p>
                    <p><strong>รายละเอียด:</strong> <span id="modalProductDescription"></span></p>
                    <p class="price">ราคา: <span id="modalProductPrice"></span> บาท</p>
                    <p class="stock">คงเหลือ: <span id="modalProductStock"></span> ชิ้น</p>

                    <div class="form-group">
                        <label for="modalProductSize">เลือกขนาด:</label>
                        <select id="modalProductSize">
                            <!-- Sizes will be populated by JS -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="modalProductQuantity">จำนวน:</label>
                        <input type="number" id="modalProductQuantity" value="1" min="1" max="100">
                    </div>
                    <button class="add-to-cart-btn" onclick="addToCartFromModal()">เพิ่มลงตะกร้า</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // กำหนด URL ของ Google Apps Script
        const API_URL = 'https://script.google.com/macros/s/AKfycbySr_Yl1kYS8vHV1UItFshepR5_goKvY0RF-yJC5cBqDGlXAUx9tF60wc5EWik_aDF73g/exec'; // *** สำคัญ: เปลี่ยน URL นี้! ***
        
        let currentProduct = null;
        let products = [];
        let cart = JSON.parse(localStorage.getItem('cart')) || []; // โหลดตะกร้าจาก Local Storage
        
        // DOM Elements
        const productGrid = document.getElementById('product-grid');
        const cartItemsList = document.getElementById('cart-items');
        const cartTotalSpan = document.getElementById('total-amount');
        const emptyCartMessage = document.getElementById('empty-cart-message');
        const cartTotalContainer = document.getElementById('cart-total');
        const proceedToCheckoutBtn = document.getElementById('proceed-to-checkout-btn');

        const productModal = document.getElementById('productModal');
        const modalProductName = document.getElementById('modalProductName');
        const modalProductImage = document.getElementById('modalProductImage');
        const modalProductCategory = document.getElementById('modalProductCategory');
        const modalProductColor = document.getElementById('modalProductColor');
        const modalProductDescription = document.getElementById('modalProductDescription');
        const modalProductPrice = document.getElementById('modalProductPrice');
        const modalProductStock = document.getElementById('modalProductStock');
        const modalProductSize = document.getElementById('modalProductSize');
        const modalProductQuantity = document.getElementById('modalProductQuantity');

        const checkoutForm = document.getElementById('checkoutForm');
        const checkoutLoading = document.getElementById('checkoutLoading');
        const checkoutMessage = document.getElementById('checkoutMessage');

        const paymentForm = document.getElementById('paymentForm');
        const paymentLoading = document.getElementById('paymentLoading');
        const paymentMessage = document.getElementById('paymentMessage');

        // โหลดสินค้าและอัปเดตตะกร้าเมื่อหน้าเว็บเริ่มต้น
        window.onload = function() {
            loadProducts();
            updateCartDisplay();
            showSection('product-list-section'); // แสดงหน้าสินค้าเป็นค่าเริ่มต้น
        };

        // ฟังก์ชันเปลี่ยน Section
        function showSection(sectionId) {
            document.getElementById('product-list-section').style.display = 'none';
            document.getElementById('cart-section').style.display = 'none';
            document.getElementById('checkout-section').style.display = 'none';
            document.getElementById('payment-section').style.display = 'none';

            document.getElementById(sectionId).style.display = 'block';

            // หากเป็นส่วนตะกร้าสินค้า ให้อัปเดตการแสดงผล
            if (sectionId === 'cart-section') {
                updateCartDisplay();
            }
        }

        // ฟังก์ชันโหลดสินค้า
        async function loadProducts() {
            try {
                const response = await fetch(`${API_URL}?action=getProducts`);
                const data = await response.json();
                
                if (data.success) {
                    products = data.products;
                    displayProducts();
                } else {
                    console.error('Error loading products:', data.error);
                    productGrid.innerHTML = '<p style="text-align: center; width: 100%; color: red;">ไม่สามารถโหลดสินค้าได้: ' + data.error + '</p>';
                }
            } catch (error) {
                console.error('Network error loading products:', error);
                productGrid.innerHTML = '<p style="text-align: center; width: 100%; color: red;">เกิดข้อผิดพลาดในการเชื่อมต่อ: ' + error.message + '</p>';
            }
        }

        // ฟังก์ชันแสดงสินค้า
        function displayProducts() {
            productGrid.innerHTML = ''; // Clear existing products
            if (products.length === 0) {
                productGrid.innerHTML = '<p style="text-align: center; width: 100%; color: #555;">ไม่มีสินค้าในขณะนี้</p>';
                return;
            }

            products.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                productCard.innerHTML = `
                    <img src="${product.image}" alt="${product.name}">
                    <div class="product-info">
                        <div>
                            <h3>${product.name}</h3>
                            <p><strong>หมวดหมู่:</strong> ${product.category}</p>
                            <p><strong>สี:</strong> ${product.color}</p>
                            <p><strong>คงเหลือ:</strong> ${product.stock} ชิ้น</p>
                        </div>
                        <p class="product-price">${product.price} บาท</p>
                        <button class="add-to-cart-btn" onclick="openProductModal('${product.id}')">รายละเอียด & เพิ่มลงตะกร้า</button>
                    </div>
                `;
                productGrid.appendChild(productCard);
            });
        }

        // ฟังก์ชันเปิด Modal แสดงรายละเอียดสินค้า
        function openProductModal(productId) {
            currentProduct = products.find(p => p.id == productId);
            if (!currentProduct) return;

            modalProductName.textContent = currentProduct.name;
            modalProductImage.src = currentProduct.image;
            modalProductCategory.textContent = currentProduct.category;
            modalProductColor.textContent = currentProduct.color;
            modalProductDescription.textContent = currentProduct.description;
            modalProductPrice.textContent = currentProduct.price;
            modalProductStock.textContent = currentProduct.stock;
            modalProductQuantity.value = 1; // Reset quantity

            // Populate sizes
            modalProductSize.innerHTML = '';
            const sizes = currentProduct.size.split(',').map(s => s.trim());
            if (sizes.length === 0 || sizes[0] === '') { // Handle empty or single blank size
                const option = document.createElement('option');
                option.value = 'N/A'; // Not Applicable
                option.textContent = 'ไม่มีตัวเลือกขนาด';
                modalProductSize.appendChild(option);
                modalProductSize.disabled = true;
            } else {
                modalProductSize.disabled = false;
                sizes.forEach(size => {
                    const option = document.createElement('option');
                    option.value = size;
                    option.textContent = size;
                    modalProductSize.appendChild(option);
                });
            }
            
            // Set max quantity based on stock
            modalProductQuantity.max = currentProduct.stock;
            if (currentProduct.stock === 0) {
                modalProductQuantity.value = 0;
                modalProductQuantity.disabled = true;
                modalProductSize.disabled = true;
                document.querySelector('#productModal .add-to-cart-btn').disabled = true;
                document.querySelector('#productModal .add-to-cart-btn').textContent = 'สินค้าหมด';
            } else {
                modalProductQuantity.disabled = false;
                // modalProductSize.disabled is handled above
                document.querySelector('#productModal .add-to-cart-btn').disabled = false;
                document.querySelector('#productModal .add-to-cart-btn').textContent = 'เพิ่มลงตะกร้า';
            }

            productModal.style.display = 'flex';
        }

        // ฟังก์ชันปิด Modal
        function closeProductModal() {
            productModal.style.display = 'none';
            currentProduct = null;
        }

        // ฟังก์ชันเพิ่มสินค้าลงตะกร้าจาก Modal
        function addToCartFromModal() {
            if (!currentProduct) return;

            const selectedSize = modalProductSize.value === 'N/A' ? '' : modalProductSize.value; // Handle N/A size
            const quantity = parseInt(modalProductQuantity.value);

            if (quantity <= 0 || isNaN(quantity)) {
                alert('โปรดระบุจำนวนสินค้าที่ถูกต้อง');
                return;
            }
            if (quantity > currentProduct.stock) {
                alert(`สินค้ามีในสต็อกเพียง ${currentProduct.stock} ชิ้น`);
                return;
            }

            addToCart(currentProduct, quantity, selectedSize);
            closeProductModal();
            showSection('cart-section'); // ไปที่หน้าตะกร้าสินค้า
        }

        // ฟังก์ชันเพิ่มสินค้าลงตะกร้า
        function addToCart(product, quantity, size) {
            const existingItemIndex = cart.findIndex(item => item.id === product.id && item.size === size);

            if (existingItemIndex > -1) {
                // หากสินค้านี้มีอยู่แล้วในตะกร้า ให้เพิ่มจำนวน
                if (cart[existingItemIndex].quantity + quantity > product.stock) {
                    alert(`ไม่สามารถเพิ่มสินค้าได้เกินสต็อกที่มี: ${product.stock} ชิ้น`);
                    return;
                }
                cart[existingItemIndex].quantity += quantity;
            } else {
                // หากเป็นสินค้าใหม่ ให้เพิ่มเข้าไปในตะกร้า
                cart.push({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    size: size,
                    quantity: quantity,
                    image: product.image, // เพื่อแสดงในตะกร้า
                    color: product.color // เพิ่มสีเข้ามา
                });
            }
            localStorage.setItem('cart', JSON.stringify(cart)); // บันทึกลง Local Storage
            updateCartDisplay();
            alert(`${product.name} (ขนาด ${size}) x ${quantity} เพิ่มลงตะกร้าแล้ว!`);
        }

        // ฟังก์ชันอัปเดตการแสดงผลตะกร้าสินค้า
        function updateCartDisplay() {
            cartItemsList.innerHTML = '';
            let total = 0;

            if (cart.length === 0) {
                emptyCartMessage.style.display = 'block';
                cartTotalContainer.style.display = 'none';
                proceedToCheckoutBtn.style.display = 'none';
                return;
            } else {
                emptyCartMessage.style.display = 'none';
                cartTotalContainer.style.display = 'block';
                proceedToCheckoutBtn.style.display = 'block';
            }

            cart.forEach((item, index) => {
                const listItem = document.createElement('li');
                listItem.className = 'cart-item';
                listItem.innerHTML = `
                    <div class="cart-item-details">
                        <h4>${item.name} (ขนาด ${item.size || 'N/A'})</h4>
                        <p>${item.price} บาท/ชิ้น | สี: ${item.color || 'N/A'}</p>
                    </div>
                    <div class="cart-item-controls">
                        <button class="quantity-btn" onclick="updateCartItemQuantity(${index}, -1)">-</button>
                        <span>${item.quantity}</span>
                        <button class="quantity-btn" onclick="updateCartItemQuantity(${index}, 1)">+</button>
                        <button class="remove-item-btn" onclick="removeCartItem(${index})">ลบ</button>
                    </div>
                `;
                cartItemsList.appendChild(listItem);
                total += item.price * item.quantity;
            });
            cartTotalSpan.textContent = total.toFixed(2);
        }

        // ฟังก์ชันอัปเดตจำนวนสินค้าในตะกร้า
        function updateCartItemQuantity(index, change) {
            const item = cart[index];
            const productInStock = products.find(p => p.id === item.id);

            if (!productInStock) {
                alert('ไม่พบข้อมูลสินค้าในสต็อก');
                removeCartItem(index); // Remove if product not found
                return;
            }

            const newQuantity = item.quantity + change;

            if (newQuantity <= 0) {
                removeCartItem(index);
            } else if (newQuantity > productInStock.stock) {
                alert(`สินค้ามีในสต็อกเพียง ${productInStock.stock} ชิ้น ไม่สามารถเพิ่มเกินจำนวนนี้ได้`);
            } else {
                item.quantity = newQuantity;
                localStorage.setItem('cart', JSON.stringify(cart));
                updateCartDisplay();
            }
        }

        // ฟังก์ชันลบสินค้าออกจากตะกร้า
        function removeCartItem(index) {
            if (confirm('คุณต้องการลบสินค้านี้ออกจากตะกร้าหรือไม่?')) {
                cart.splice(index, 1);
                localStorage.setItem('cart', JSON.stringify(cart));
                updateCartDisplay();
            }
        }

        // --- Checkout Form Submission ---
        checkoutForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            
            if (cart.length === 0) {
                alert('ตะกร้าสินค้าของคุณว่างเปล่า ไม่สามารถดำเนินการสั่งซื้อได้');
                return;
            }

            checkoutLoading.style.display = 'block'; 
            checkoutMessage.textContent = ''; // Clear previous messages
            document.querySelector('#checkoutForm button[type="submit"]').disabled = true; // Disable button

            const customerName = document.getElementById('checkoutCustomerName').value;
            const phone = document.getElementById('checkoutPhone').value;
            const email = document.getElementById('checkoutEmail').value;
            const address = document.getElementById('checkoutAddress').value;
            const note = document.getElementById('checkoutNote').value;
            const total = parseFloat(cartTotalSpan.textContent);

            // *** สำคัญ: สร้าง FormData เพื่อแก้ปัญหา CORS ***
            const formData = new FormData();
            formData.append('customerName', customerName);
            formData.append('phone', phone);
            formData.append('email', email);
            formData.append('address', address);
            formData.append('note', note);
            formData.append('total', total);
            formData.append('cartItems', JSON.stringify(cart)); // แปลง array/object cart เป็น JSON string ก่อนส่ง

            try {
                const response = await fetch(`${API_URL}?action=createOrder`, {
                    method: 'POST',
                    // ไม่ต้องระบุ headers: { 'Content-Type': 'application/json' } เมื่อใช้ FormData
                    body: formData // ใช้ FormData ที่สร้างขึ้น
                });
                const data = await response.json();

                if (data.success) {
                    checkoutMessage.textContent = `สั่งซื้อสำเร็จ! หมายเลขคำสั่งซื้อของคุณคือ ${data.orderId}. กรุณาจดไว้เพื่อแจ้งชำระเงิน`;
                    checkoutMessage.style.color = 'green';
                    checkoutMessage.className = 'message success';
                    
                    cart = []; // ล้างตะกร้าหลังสั่งซื้อสำเร็จ
                    localStorage.removeItem('cart');
                    updateCartDisplay();
                    checkoutForm.reset(); // ล้างฟอร์ม
                    
                    // นำไปสู่หน้าแจ้งชำระเงินและกรอก Order ID อัตโนมัติ
                    showSection('payment-section'); 
                    document.getElementById('paymentConfirmOrderId').value = data.orderId; 
                    document.getElementById('amountPaid').value = total.toFixed(2); // กรอกยอดเงินที่ต้องชำระ
                } else {
                    console.error('Error creating order:', data.error);
                    checkoutMessage.textContent = 'เกิดข้อผิดพลาดในการสั่งซื้อ: ' + data.error;
                    checkoutMessage.className = 'message error';
                }
            } catch (error) {
                console.error('Network error during order creation:', error);
                checkoutMessage.textContent = 'เกิดข้อผิดพลาดในการเชื่อมต่อ: ' + error.message + '. โปรดตรวจสอบการเชื่อมต่ออินเทอร์เน็ตหรือ URL ของ Apps Script.';
                checkoutMessage.className = 'message error';
            } finally {
                checkoutLoading.style.display = 'none'; 
                document.querySelector('#checkoutForm button[type="submit"]').disabled = false;
            }
        });

        // --- Payment Confirmation Form Submission ---
        paymentForm.addEventListener('submit', async (event) => {
            event.preventDefault();

            paymentLoading.style.display = 'block';
            paymentMessage.textContent = '';
            document.querySelector('#paymentForm button[type="submit"]').disabled = true;

            const orderId = document.getElementById('paymentConfirmOrderId').value;
            const payerName = document.getElementById('payerName').value;
            const payerBank = document.getElementById('payerBank').value;
            const amountPaid = parseFloat(document.getElementById('amountPaid').value);
            const paymentDate = document.getElementById('paymentDate').value;
            const paymentSlipFile = document.getElementById('paymentSlip').files[0];

            if (!paymentSlipFile) {
                alert('โปรดแนบรูปสลิปโอนเงิน');
                paymentLoading.style.display = 'none';
                document.querySelector('#paymentForm button[type="submit"]').disabled = false;
                return;
            }

            const reader = new FileReader();
            reader.readAsDataURL(paymentSlipFile); // อ่านไฟล์เป็น Base64

            reader.onloadend = async () => {
                const slipBase64 = reader.result; // data:image/png;base64,...
                const slipMimeType = paymentSlipFile.type; // image/png, image/jpeg

                // *** สำคัญ: สร้าง FormData เพื่อแก้ปัญหา CORS ***
                const formData = new FormData();
                formData.append('orderId', orderId);
                formData.append('payerName', payerName);
                formData.append('payerBank', payerBank);
                formData.append('amountPaid', amountPaid);
                formData.append('paymentDate', paymentDate);
                formData.append('slipBase64', slipBase64); // ส่ง Base64 string ของสลิป
                formData.append('slipMimeType', slipMimeType); // ส่ง MimeType ของสลิป

                try {
                    const response = await fetch(`${API_URL}?action=confirmPayment`, {
                        method: 'POST',
                        // ไม่ต้องระบุ headers: { 'Content-Type': 'application/json' } เมื่อใช้ FormData
                        body: formData // ใช้ FormData ที่สร้างขึ้น
                    });
                    const data = await response.json();

                    if (data.success) {
                        paymentMessage.textContent = 'แจ้งชำระเงินสำเร็จ! เจ้าหน้าที่จะตรวจสอบข้อมูลของคุณ';
                        paymentMessage.className = 'message success';
                        paymentForm.reset(); // ล้างฟอร์ม
                    } else {
                        console.error('Error confirming payment:', data.error);
                        paymentMessage.textContent = 'เกิดข้อผิดพลาดในการแจ้งชำระเงิน: ' + data.error;
                        paymentMessage.className = 'message error';
                    }
                } catch (error) {
                    console.error('Network error during payment confirmation:', error);
                    paymentMessage.textContent = 'เกิดข้อผิดพลาดในการเชื่อมต่อ: ' + error.message + '. โปรดตรวจสอบการเชื่อมต่ออินเทอร์เน็ตหรือ URL ของ Apps Script.';
                    paymentMessage.className = 'message error';
                } finally {
                    paymentLoading.style.display = 'none';
                    document.querySelector('#paymentForm button[type="submit"]').disabled = false;
                }
            };
        });

        // Event listener สำหรับปุ่ม "ดำเนินการสั่งซื้อ" ในตะกร้า
        proceedToCheckoutBtn.addEventListener('click', () => {
            showSection('checkout-section');
        });
    </script>
</body>
</html>
